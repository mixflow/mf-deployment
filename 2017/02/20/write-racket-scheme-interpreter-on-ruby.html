<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/assets/css/styles.css">
  <script src="/assets/javascript/main.js"></script><link rel="shortcut icon" type="image/png" href="/assets/favicon.png">
</head>
<body><header class="site-header wrapper">
  <a class="site-logo-title-container" href="/">
    
      
        
        <?xml version="1.0" encoding="UTF-8"?>
<!-- Generator: Blender, SVG Export for Grease Pencil - v1.0 -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg class="site-logo" version="1.0" x="0px" y="0px" xmlns="http://www.w3.org/2000/svg" width="195px" height="594px" viewBox="0 0 195 594">
	<g id="blender_frame_1">
		<g id="blender_object_GPencil">
			<!--Layer: GP_Layer-->
			<g id="GP_Layer">
				<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="53.681030,10.000000 53.681030,10.537537 53.681030,11.075134 53.681030,11.612793 53.681030,12.150269 53.681030,12.687927 53.681030,13.225525 53.681030,13.763062 53.681030,14.300659 53.681030,14.838257 53.681030,15.375793 53.681030,15.913330 53.681030,16.450867 64.063843,16.450867 74.446655,16.450867 84.829346,16.450867 95.211914,16.450867 105.594727,16.450867 115.977295,16.450867 126.360107,16.450867 136.742920,16.450867 147.125610,16.450867 157.508301,16.450867 167.890991,16.450867 178.273804,16.450867 178.273804,20.613159 178.273804,24.775391 178.273804,28.937744 178.273804,33.099976 178.273804,37.262329 178.273804,41.424561 178.273804,45.586914 178.273804,49.749268 178.273804,53.911499 178.273804,58.073853 178.273804,62.236084 178.273804,66.398438 178.842041,66.398438 179.410278,66.398438 179.978516,66.398438 180.546875,66.398438 181.115234,66.398438 181.683472,66.398438 182.251709,66.398438 182.819946,66.398438 183.388306,66.398438 183.956665,66.398438 184.524902,66.398438 185.093018,66.398438 185.093018,61.698547 185.093018,56.998718 185.093018,52.298828 185.093018,47.598999 185.093018,42.899048 185.093018,38.199158 185.093018,33.499329 185.093018,28.799438 185.093018,24.099487 185.093018,19.399719 185.093018,14.699768 185.093018,10.000000 174.142090,10.000000 163.191162,10.000000 152.240112,10.000000 141.289185,10.000000 130.338257,10.000000 119.387085,10.000000 108.436157,10.000000 97.485229,10.000000 86.534058,10.000000 75.583130,10.000000 64.632080,10.000000 54.228760,10.000000" />
				<mask id="mask-square">
					<!-- the rectangle works as the background -->
					<rect fill="white" x="0" y="0" width="195px" height="594px"  viewBox="0 0 195 594"/>
					<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="0" points="151.180420,122.833740 151.180420,124.738281 151.180420,126.642822 151.180420,128.547363 151.180420,130.451843 151.180420,132.356384 151.180420,134.260925 151.180420,136.165466 151.180420,138.070007 151.180420,139.974426 151.180420,141.878967 151.180420,143.783508 151.180420,145.687988 145.774048,145.687988 140.367554,145.687988 134.961182,145.687988 129.554810,145.687988 124.148560,145.687988 118.741943,145.687988 113.335693,145.687988 107.929321,145.687988 102.522949,145.687988 97.116455,145.687988 91.710083,145.687988 86.303711,145.687988 86.303711,143.783447 86.303711,141.878967 86.303711,139.974426 86.303711,138.069885 86.303711,136.165344 86.303711,134.260803 86.303711,132.356384 86.303711,130.451843 86.303711,128.547302 86.303711,126.642761 86.303711,124.738220 86.303711,122.833740 91.710083,122.833740 97.116577,122.833740 102.522949,122.833740 107.929321,122.833740 113.335693,122.833740 118.741943,122.833740 124.148560,122.833740 129.554810,122.833740 134.961182,122.833740 140.367554,122.833740 145.774048,122.833740 150.910156,122.833740" />
					<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="0" points="86.303711,173.702942 86.303711,171.813782 86.303711,169.924622 86.303711,168.035461 86.303711,166.146240 86.303711,164.257080 86.303711,162.367920 86.303711,160.478760 86.303711,158.589600 86.303711,156.700439 86.303711,154.811279 86.303711,152.922119 86.303711,151.032959 91.710083,151.032959 97.116577,151.032959 102.522949,151.032959 107.929321,151.032959 113.335693,151.032959 118.741943,151.032959 124.148560,151.032959 129.554810,151.032959 134.961182,151.032959 140.367554,151.032959 145.774048,151.032959 151.180420,151.032959 151.180420,152.922119 151.180420,154.811279 151.180420,156.700439 151.180420,158.589600 151.180420,160.478760 151.180420,162.367920 151.180420,164.257080 151.180420,166.146240 151.180420,168.035461 151.180420,169.924622 151.180420,171.813782 151.180420,173.702942 145.774048,173.702942 140.367554,173.702942 134.961182,173.702942 129.554810,173.702942 124.148560,173.702942 118.741943,173.702942 113.335693,173.702942 107.929321,173.702942 102.522949,173.702942 97.116455,173.702942 91.710083,173.702942 86.573975,173.702942" />
				</mask>

				<polygon mask="url(#mask-square)" stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="86.303711,179.232239 91.710083,179.232239 97.116577,179.232239 102.522949,179.232239 107.929321,179.232239 113.335693,179.232239 118.741943,179.232239 124.148560,179.232239 129.554810,179.232239 134.961182,179.232239 140.367554,179.232239 145.774048,179.232239 151.180420,179.232239 151.180420,179.923340 151.180420,180.614563 151.180420,181.305664 151.180420,181.996887 151.180420,182.687988 151.180420,183.379150 151.180420,184.070312 151.180420,184.761475 151.180420,185.452637 151.180420,186.143799 151.180420,186.834900 151.180420,187.526123 151.333984,187.526123 151.487549,187.526123 151.641113,187.526123 151.794678,187.526123 151.948242,187.526123 152.101807,187.526123 152.255615,187.526123 152.409180,187.526123 152.562744,187.526123 152.716309,187.526123 152.869873,187.526123 153.023438,187.526123 154.025269,187.474792 155.079102,187.330688 156.159546,187.108521 157.242065,186.822998 158.301514,186.488770 159.312988,186.120667 160.251465,185.733398 161.092041,185.341675 161.809814,184.960205 162.379639,184.603577 162.776855,184.286743 162.976196,184.024231 162.976196,179.124695 162.976196,174.225159 162.976196,169.325562 162.976196,164.426086 162.976196,159.526550 162.976196,154.627014 162.976196,149.727478 162.976196,144.827881 162.976196,139.928406 162.976196,135.028870 162.976196,130.129272 162.976196,125.229736 163.881714,125.030518 164.752686,124.803162 165.585205,124.550171 166.375488,124.274109 167.119873,123.977539 167.814209,123.663147 168.454712,123.333374 169.037842,122.990784 169.559448,122.637939 170.015625,122.277405 170.402954,121.911743 170.717041,121.543579 169.488281,120.591309 168.259521,119.639099 167.030884,118.686768 165.802246,117.734558 164.573486,116.782349 163.344727,115.830139 162.115967,114.877808 160.887329,113.925598 159.658569,112.973328 158.429810,112.020996 157.201172,111.068787 155.972412,110.116455 155.419434,110.730835 154.866455,111.345215 154.313599,111.959595 153.760620,112.573914 153.207886,113.188232 152.654785,113.802551 152.101807,114.416931 151.549072,115.031311 150.995972,115.645691 150.443237,116.260010 149.890137,116.874390 149.337158,117.488831 144.284180,117.488831 139.231079,117.488831 134.177856,117.488831 129.124756,117.488831 124.071777,117.488831 119.018433,117.488831 113.965454,117.488831 108.912231,117.488831 103.859131,117.488831 98.806030,117.488831 93.752808,117.488831 88.699707,117.488831 87.532471,116.997314 86.365234,116.505859 85.197876,116.014404 84.030640,115.522827 82.863403,115.031372 81.696045,114.539856 80.528809,114.048401 79.361450,113.556946 78.194214,113.065369 77.026978,112.573914 75.859497,112.082397 74.692261,111.590942 74.692261,117.749878 74.692261,123.908875 74.692261,130.067871 74.692261,136.226807 74.692261,142.385864 74.692261,148.544739 74.692261,154.703796 74.692261,160.862732 74.692261,167.021729 74.692261,173.180725 74.692261,179.339661 74.692261,185.498657 74.845825,185.498657 74.999512,185.498657 75.153076,185.498657 75.306641,185.498657 75.460205,185.498657 75.613892,185.498657 75.767456,185.498657 75.921021,185.498657 76.074585,185.498657 76.228149,185.498657 76.381836,185.498657 76.535400,185.498657 77.966553,185.443665 79.306885,185.288818 80.549805,185.049438 81.689209,184.740906 82.718506,184.378723 83.631226,183.978149 84.421143,183.554504 85.081787,183.123169 85.606812,182.699463 85.989746,182.298828 86.224121,181.936646 86.303711,181.628235 86.303711,181.428589 86.303711,181.228882 86.303711,181.029236 86.303711,180.829529 86.303711,180.629822 86.303711,180.430176 86.303711,180.230530 86.303711,180.030884 86.303711,179.831177 86.303711,179.631531 86.303711,179.431885 86.303711,179.242188" />

				<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="25.481934,111.775208 27.680664,113.207642 29.924927,114.817993 32.183228,116.584534 34.424316,118.485474 36.616699,120.498962 38.729126,122.603394 40.730103,124.776855 42.588501,126.997742 44.272705,129.244202 45.751587,131.494507 46.993652,133.726929 47.967529,135.919617 51.214844,137.073181 54.041138,136.976868 56.301758,135.824585 57.851929,133.810364 58.547241,131.127991 58.242798,127.971313 56.794067,124.534424 54.056641,121.011169 49.885498,117.595276 44.136353,114.480957 36.664307,111.861877 27.325073,109.932129 27.171387,110.085693 27.017822,110.239319 26.864258,110.393005 26.710693,110.546509 26.557007,110.700134 26.403442,110.853760 26.249878,111.007324 26.096191,111.160950 25.942627,111.314514 25.789062,111.468140 25.635498,111.621704 25.489624,111.767639" />
				<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="12.211670,152.507446 14.219238,153.797913 16.261353,155.259216 18.311157,156.870422 20.341797,158.610107 22.326294,160.457397 24.237793,162.391052 26.049561,164.389954 27.734619,166.432922 29.265991,168.499084 30.616943,170.567139 31.760498,172.615967 32.669922,174.624512 35.833862,175.789856 38.598511,175.730347 40.825562,174.641724 42.376831,172.719971 43.114136,170.160767 42.899048,167.160034 41.593506,163.913391 39.059326,160.617065 35.158081,157.466492 29.751709,154.657715 22.701904,152.386536 13.870483,150.848694 13.732178,150.986938 13.593994,151.125122 13.455811,151.263306 13.317505,151.401611 13.179321,151.539856 13.041016,151.678040 12.902832,151.816223 12.764648,151.954468 12.626343,152.092712 12.488159,152.230957 12.349854,152.369141 12.218506,152.500488" />
				<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="66.951416,129.100281 58.938354,148.536499 52.230591,164.759888 46.699341,178.090454 42.215820,188.848328 38.651367,197.353455 35.877075,203.926025 33.764282,208.886169 32.184082,212.553833 31.007812,215.249146 30.106934,217.292114 29.352173,219.002930 28.615112,220.701660 28.221802,221.590881 27.865112,222.332214 27.535278,222.939270 27.222656,223.425293 26.917603,223.803833 26.610840,224.088257 26.292358,224.292114 25.952881,224.428772 25.582764,224.511658 25.172119,224.554199 24.711670,224.569885 24.191650,224.572083 23.515991,224.572083 22.840088,224.572083 22.164307,224.572083 21.488525,224.572083 20.812744,224.572083 20.136963,224.572083 19.461182,224.572083 18.785400,224.572083 18.109619,224.572083 17.433716,224.572083 16.758057,224.572083 16.082153,224.572083 16.082153,224.909973 16.082153,225.247925 16.082153,225.585815 16.082153,225.923706 16.082153,226.261597 16.082153,226.599487 16.082153,226.937378 16.082153,227.275330 16.082153,227.613220 16.082153,227.951111 16.082153,228.289001 16.082153,228.626892 17.020874,228.727234 17.905518,228.845032 18.741333,228.982178 19.533325,229.140503 20.286987,229.321960 21.007446,229.528198 21.700195,229.761230 22.370117,230.022766 23.022705,230.314758 23.663330,230.638977 24.296997,230.997253 24.928955,231.391541 25.923218,232.320312 26.785767,233.707336 27.515137,235.526978 28.109985,237.753601 28.569336,240.361633 28.891602,243.325500 29.075684,246.619629 29.120361,250.218323 29.024048,254.096069 28.785889,258.227173 28.404175,262.586182 27.877930,267.147400 28.004639,268.571289 28.200439,269.891541 28.465332,271.104309 28.799438,272.205688 29.202637,273.191833 29.674927,274.059021 30.216309,274.803223 30.826904,275.420837 31.506470,275.907837 32.255249,276.260437 33.073120,276.474792 33.960083,276.547119 35.474121,276.444702 36.880615,276.142090 38.176147,275.646240 39.357422,274.964233 40.420898,274.102966 41.363281,273.069580 42.180908,271.871033 42.870728,270.514282 43.428955,269.006348 43.852539,267.354248 44.137817,265.564941 44.281372,263.645569 44.299561,259.970154 44.104736,256.574402 43.737061,253.430786 43.236938,250.511841 42.644653,247.789978 42.000488,245.237732 41.344849,242.827515 40.718018,240.531860 40.160278,238.323242 39.712036,236.174194 39.413574,234.057068 39.305054,231.944458 39.330811,230.716553 39.406250,229.432678 39.528564,228.098816 39.694580,226.720642 39.901733,225.304077 40.146851,223.854980 40.427002,222.379150 40.739502,220.882446 41.081299,219.370728 41.449707,217.849792 41.841553,216.325562 42.253906,214.803711 43.224121,211.544556 44.701172,206.884460 46.608276,201.035339 48.868652,194.208923 51.405396,186.617249 54.141846,178.471924 57.001221,169.984863 59.906616,161.367859 62.781372,152.832825 65.548584,144.591553 68.131470,136.855774 70.453247,129.837463 70.161377,129.776001 69.869629,129.714661 69.577759,129.653198 69.285889,129.591736 68.994141,129.530273 68.702271,129.468811 68.410522,129.407349 68.118652,129.345947 67.826782,129.284485 67.535034,129.223022 67.243164,129.161621 66.965942,129.103271" />
				<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="117.083374,244.108826 114.093628,245.341187 111.120605,246.549194 108.173096,247.731628 105.260132,248.887207 102.390991,250.014587 99.573975,251.112549 96.818604,252.179810 94.133545,253.215027 91.527710,254.216980 89.010254,255.184448 86.590210,256.115967 84.276245,257.010437 84.276245,254.061523 84.276245,251.112549 84.276245,248.163635 84.276245,245.214722 84.276245,242.265747 84.276245,239.316772 84.276245,236.367859 84.276245,233.418945 84.276245,230.469971 84.276245,227.521057 84.276245,224.572083 84.276245,221.623169 86.672363,221.623169 89.068359,221.623169 91.464355,221.623169 93.860474,221.623169 96.256470,221.623169 98.652466,221.623169 101.048340,221.623169 103.444336,221.623169 105.840454,221.623169 108.236450,221.623169 110.632446,221.623169 113.028442,221.623169 113.654297,221.603882 114.240967,221.545532 114.788086,221.447510 115.294800,221.309204 115.760620,221.129883 116.184814,220.908997 116.566650,220.645874 116.905762,220.339844 117.201416,219.990295 117.452759,219.596680 117.659424,219.158142 117.820557,218.674255 116.556396,217.312073 115.187378,215.917297 113.754150,214.518677 112.298096,213.144958 110.859741,211.825073 109.480469,210.587708 108.201050,209.461670 107.062378,208.475830 106.105347,207.658936 105.371216,207.039734 104.900635,206.647156 104.734619,206.509827 104.151001,207.308533 103.567261,208.107178 102.983643,208.905884 102.400024,209.704590 101.816406,210.503174 101.232788,211.301880 100.649048,212.100586 100.065430,212.899170 99.481812,213.697876 98.898193,214.496582 98.314575,215.295227 97.730835,216.093933 96.609741,216.093933 95.488403,216.093933 94.367310,216.093933 93.245972,216.093933 92.124878,216.093933 91.003662,216.093933 89.882324,216.093933 88.761230,216.093933 87.639893,216.093933 86.518799,216.093933 85.397583,216.093933 84.276245,216.093933 84.276245,214.404419 84.276245,212.714905 84.276245,211.025452 84.276245,209.335938 84.276245,207.646423 84.276245,205.956909 84.276245,204.267456 84.276245,202.577942 84.276245,200.888428 84.276245,199.198914 84.276245,197.509460 84.276245,195.819946 85.332764,195.616516 86.291870,195.374573 87.156128,195.094299 87.928345,194.775574 88.611084,194.418457 89.206665,194.022949 89.717651,193.589050 90.146973,193.116760 90.496826,192.606079 90.769775,192.057007 90.968750,191.469543 91.095825,190.843689 89.559937,190.659302 88.024048,190.475037 86.488159,190.290649 84.952026,190.106384 83.416138,189.922119 81.880249,189.737793 80.344360,189.553467 78.808472,189.369202 77.272583,189.184875 75.736694,189.000610 74.200806,188.816223 72.664917,188.631958 72.664917,194.284058 72.664917,199.936218 72.664917,205.588318 72.664917,211.240479 72.664917,216.892578 72.664917,222.544739 72.664917,228.196838 72.664917,233.848999 72.664917,239.501099 72.664917,245.153259 72.664917,250.805359 72.664917,256.457520 72.643433,257.120300 72.570190,257.735718 72.431641,258.317871 72.214355,258.880859 71.904907,259.438660 71.489868,260.005432 70.955933,260.595276 70.289307,261.222229 69.476929,261.900330 68.505127,262.643799 67.360596,263.466614 66.029785,264.382751 66.767090,265.319702 67.504272,266.256592 68.241455,267.193481 68.978638,268.130432 69.715942,269.067322 70.453247,270.004150 71.190430,270.941101 71.927612,271.877991 72.664917,272.814880 73.402100,273.751831 74.139404,274.688721 74.876587,275.625610 75.156494,275.426147 75.441528,275.197266 75.729004,274.940186 76.016602,274.656311 76.301636,274.346741 76.581543,274.012939 76.853638,273.656006 77.115601,273.277344 77.364746,272.878296 77.598633,272.459900 77.814453,272.023743 78.009766,271.570801 82.006836,269.124329 85.964111,266.682373 89.857422,264.264709 93.662476,261.891235 97.354736,259.581665 100.910278,257.356018 104.304321,255.234009 107.512817,253.235535 110.511597,251.380371 113.275879,249.688416 115.781738,248.179504 118.004761,246.873474 117.927979,246.643066 117.851196,246.412720 117.774414,246.182312 117.697632,245.951904 117.620850,245.721558 117.544067,245.491089 117.467285,245.260742 117.390503,245.030334 117.313721,244.799927 117.236938,244.569580 117.160156,244.339172 117.087158,244.120300" />
				<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="178.273804,237.842346 178.074097,237.842346 177.874390,237.842346 177.674805,237.842346 177.475098,237.842346 177.275391,237.842346 177.075684,237.842346 176.875977,237.842346 176.676392,237.842346 176.476685,237.842346 176.276978,237.842346 176.077515,237.842346 175.877808,237.842346 175.449341,240.144653 174.998535,242.428040 174.531372,244.669006 174.055176,246.843994 173.576294,248.929321 173.101562,250.901489 172.637695,252.736938 172.191528,254.412109 171.769531,255.903259 171.378784,257.187073 171.025757,258.239746 170.717041,259.037842 170.574707,259.341553 170.421875,259.609497 170.256348,259.844177 170.075317,260.048096 169.876587,260.223877 169.657227,260.374084 169.414917,260.501221 169.146973,260.607849 168.850952,260.696594 168.524170,260.770020 168.164062,260.830566 167.768188,260.880920 167.289185,260.923218 166.686279,260.958618 165.965332,260.987488 165.133179,261.010620 164.196045,261.028687 163.160400,261.042175 162.032593,261.051880 160.818970,261.058350 159.526123,261.062317 158.160278,261.064331 156.727783,261.065125 155.235107,261.065247 154.160034,261.065247 153.084961,261.065247 152.009766,261.065247 150.934570,261.065247 149.859497,261.065247 148.784424,261.065247 147.709229,261.065247 146.634033,261.065247 145.559082,261.065247 144.483887,261.065247 143.408691,261.065247 142.333496,261.065247 141.094727,261.049011 140.040771,260.996948 139.157104,260.903931 138.428955,260.764893 137.841553,260.574585 137.380249,260.328003 137.030273,260.019958 136.776978,259.645386 136.605591,259.199097 136.501465,258.676025 136.449585,258.071045 136.435669,257.379028 136.435669,254.890869 136.435669,252.402710 136.435669,249.914551 136.435669,247.426392 136.435669,244.938232 136.435669,242.450012 136.435669,239.961914 136.435669,237.473694 136.435669,234.985535 136.435669,232.497375 136.435669,230.009216 136.435669,227.521057 139.924072,226.165955 143.454834,224.697571 146.993164,223.140869 150.504639,221.520752 153.954712,219.862366 157.308594,218.190430 160.532104,216.530090 163.590454,214.906189 166.449219,213.343689 169.073730,211.867615 171.429321,210.502869 173.481689,209.274536 174.150024,209.524170 174.774414,209.720764 175.356567,209.864868 175.898193,209.957153 176.401611,209.998230 176.868408,209.988708 177.300781,209.929260 177.700317,209.820618 178.069336,209.663269 178.409424,209.457947 178.722534,209.205261 179.010986,208.905884 177.981934,207.999695 176.952881,207.093506 175.923950,206.187378 174.894653,205.281189 173.865601,204.374939 172.836548,203.468811 171.807617,202.562622 170.778564,201.656494 169.749512,200.750244 168.720459,199.844055 167.691284,198.937927 166.662231,198.031677 164.993896,199.704468 163.053711,201.568542 160.876709,203.592590 158.498047,205.745300 155.953003,207.995300 153.276855,210.311218 150.504639,212.661682 147.671753,215.015381 144.813110,217.340881 141.964111,219.606873 139.159912,221.781982 136.435669,223.834839 136.435669,221.377441 136.435669,218.919983 136.435669,216.462524 136.435669,214.005127 136.435669,211.547668 136.435669,209.090210 136.435669,206.632751 136.435669,204.175293 136.435669,201.717834 136.435669,199.260376 136.435669,196.802917 136.435669,194.345459 137.276611,194.180908 138.048462,193.965759 138.751099,193.703369 139.384644,193.396667 139.948975,193.049072 140.444336,192.663696 140.870605,192.243774 141.227661,191.792480 141.515747,191.313049 141.734497,190.808655 141.884277,190.282471 141.964844,189.737793 140.536621,189.568848 139.108154,189.399902 137.679688,189.230896 136.251465,189.062012 134.822998,188.893066 133.394653,188.724060 131.966187,188.555115 130.537720,188.386230 129.109497,188.217224 127.681030,188.048340 126.252686,187.879395 124.824219,187.710388 124.824219,193.761902 124.824219,199.813293 124.824219,205.864807 124.824219,211.916260 124.824219,217.967712 124.824219,224.019226 124.824219,230.070679 124.824219,236.122192 124.824219,242.173645 124.824219,248.225037 124.824219,254.276550 124.824219,260.328003 124.882080,262.295105 125.072632,264.054260 125.420410,265.612488 125.950439,266.976746 126.688110,268.154175 127.657959,269.151794 128.885132,269.976562 130.394409,270.635620 132.210938,271.135986 134.359619,271.484619 136.865479,271.688660 139.753296,271.755127 141.012695,271.755127 142.271973,271.755127 143.531616,271.755127 144.791016,271.755127 146.050415,271.755127 147.309937,271.755127 148.569336,271.755127 149.828735,271.755127 151.088257,271.755127 152.347656,271.755127 153.607056,271.755127 154.866455,271.755127 160.349365,271.712219 165.123901,271.581055 169.234009,271.357727 172.724121,271.038330 175.638184,270.619202 178.020386,270.096375 179.914795,269.466003 181.365967,268.724304 182.417847,267.867371 183.114502,266.891418 183.500122,265.792603 183.618652,264.567078 183.598267,263.990417 183.532471,263.455261 183.414185,262.957275 183.236450,262.491882 182.992065,262.054688 182.674194,261.641174 182.275513,261.246887 181.789185,260.867249 181.208252,260.497925 180.525513,260.134277 179.734009,259.771973 178.826538,259.406433 178.780640,257.609436 178.734497,255.812439 178.688477,254.015442 178.642334,252.218445 178.596191,250.421387 178.550293,248.624390 178.504150,246.827393 178.458008,245.030396 178.411987,243.233337 178.365845,241.436340 178.319946,239.639343 178.276001,237.932190" />
				<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="101.969971,317.684814 103.498413,319.159180 105.028076,320.801819 106.537354,322.589172 108.004395,324.497437 109.407349,326.502991 110.724609,328.582092 111.934448,330.711121 113.014893,332.866394 113.944214,335.024231 114.700928,337.160950 115.263062,339.252869 115.608765,341.276367 118.428467,342.870361 121.070679,343.246582 123.381470,342.569397 125.206421,341.003296 126.391479,338.712769 126.782471,335.862244 126.225098,332.616272 124.564819,329.139221 121.647949,325.595703 117.319580,322.150024 111.426270,318.966797 103.812988,316.210388 103.659424,316.333252 103.505859,316.456116 103.352295,316.578979 103.198730,316.701843 103.045166,316.824707 102.891602,316.947571 102.738037,317.070435 102.584473,317.193298 102.430664,317.316162 102.277100,317.439087 102.123535,317.561951 101.977661,317.678650" />
				<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="106.577637,350.307434 104.522339,352.920410 102.161865,355.744568 99.536499,358.722290 96.686523,361.796082 93.651978,364.908142 90.473755,368.001099 87.191650,371.017212 83.846191,373.898926 80.477905,376.588745 77.126831,379.028870 73.833130,381.161865 70.637573,382.930054 70.240723,383.071594 69.797852,383.217651 69.324341,383.364929 68.835327,383.510315 68.346436,383.650574 67.872925,383.782532 67.430054,383.902893 67.033203,384.008667 66.697998,384.096436 66.439453,384.163086 66.272949,384.205444 66.214111,384.220276 66.720947,385.418274 67.227783,386.616272 67.734619,387.814270 68.241455,389.012268 68.748291,390.210266 69.255249,391.408264 69.762085,392.606323 70.268921,393.804321 70.775757,395.002319 71.282593,396.200317 71.789429,397.398315 72.296265,398.596313 72.615112,398.492615 72.926880,398.365967 73.232178,398.216187 73.531860,398.043396 73.826416,397.847595 74.116333,397.628662 74.402588,397.386841 74.685425,397.121826 74.965820,396.833862 75.244385,396.522827 75.521606,396.188782 75.798218,395.831726 83.639282,394.592224 91.298950,393.364868 98.756104,392.154114 105.990601,390.964600 112.981934,389.800598 119.709717,388.666687 126.153198,387.567322 132.292114,386.507019 138.105957,385.490234 143.574219,384.521484 148.676392,383.605164 153.392090,382.745789 154.386108,384.173950 155.338379,385.600830 156.245972,387.025208 157.105469,388.445679 157.913818,389.861023 158.667847,391.270020 159.364258,392.671326 159.999878,394.063721 160.571411,395.445801 161.075806,396.816345 161.509888,398.174133 161.870361,399.517883 165.094604,400.988586 167.927612,401.008545 170.201538,399.762634 171.747803,397.435852 172.398193,394.213135 171.984253,390.279419 170.337646,385.819580 167.290283,381.018738 162.673706,376.061707 156.319702,371.133484 148.059814,366.419006 137.725830,362.103210 137.556885,362.241455 137.387817,362.379700 137.218994,362.517944 137.050049,362.656128 136.880981,362.794373 136.712158,362.932617 136.543213,363.070862 136.374146,363.209045 136.205200,363.347290 136.036377,363.485535 135.867310,363.623779 135.698364,363.761963 136.953003,364.805725 138.224976,365.907104 139.508545,367.062256 140.797607,368.267334 142.086914,369.518433 143.370239,370.811768 144.642212,372.143555 145.896851,373.509888 147.128418,374.906921 148.331177,376.330811 149.499512,377.777771 150.627441,379.243896 143.931396,379.753723 137.315430,380.266174 130.805786,380.776001 124.428467,381.278137 118.209717,381.767456 112.176147,382.238892 106.353638,382.687317 100.768677,383.107544 95.447144,383.494507 90.415649,383.843079 85.700439,384.148132 81.327515,384.404602 84.802246,382.506836 88.298584,380.511902 91.792725,378.437561 95.259766,376.301819 98.675781,374.122498 102.016113,371.917664 105.256592,369.705078 108.372925,367.502747 111.340942,365.328613 114.135986,363.200500 116.734009,361.136414 119.110596,359.154297 120.043945,359.293701 120.909302,359.347961 121.708252,359.324158 122.441895,359.229370 123.111572,359.070557 123.718384,358.854797 124.263916,358.589111 124.749146,358.280518 125.175659,357.936096 125.544434,357.562927 125.856934,357.167908 126.114502,356.758240 124.993164,356.220703 123.871948,355.683105 122.750732,355.145569 121.629517,354.608032 120.508423,354.070435 119.387085,353.532898 118.265991,352.995300 117.144775,352.457764 116.023438,351.920166 114.902344,351.382629 113.781006,350.845032 112.659912,350.307434 118.066284,350.307434 123.472534,350.307434 128.879150,350.307434 134.285400,350.307434 139.691772,350.307434 145.098145,350.307434 150.504639,350.307434 155.911011,350.307434 161.317383,350.307434 166.723633,350.307434 172.130005,350.307434 177.536621,350.307434 178.119995,350.288147 178.671265,350.229797 179.189575,350.131775 179.673096,349.993408 180.120972,349.814148 180.531616,349.593262 180.903809,349.330139 181.236206,349.024109 181.527832,348.674622 181.777344,348.280884 181.983154,347.842407 182.144287,347.358521 180.635742,345.893555 178.999878,344.377991 177.286011,342.845825 175.543213,341.330933 173.821045,339.867249 172.168457,338.488708 170.635010,337.229065 169.269897,336.122559 168.122437,335.202759 167.241699,334.503845 166.677124,334.059631 166.478027,333.903992 165.771484,334.825562 165.064819,335.747070 164.358521,336.668640 163.651855,337.590149 162.945312,338.511719 162.239014,339.433289 161.532349,340.354797 160.825806,341.276306 160.119263,342.197876 159.412842,343.119385 158.706299,344.040955 157.999756,344.962524 150.013184,344.962524 142.026367,344.962524 134.039551,344.962524 126.052979,344.962524 118.066284,344.962524 110.079468,344.962524 102.092896,344.962524 94.106079,344.962524 86.119507,344.962524 78.132812,344.962524 70.145996,344.962524 62.159302,344.962524 62.266846,345.407898 62.374390,345.853333 62.481812,346.298767 62.589355,346.744141 62.696899,347.189575 62.804443,347.634949 62.911987,348.080383 63.019409,348.525818 63.126953,348.971252 63.234497,349.416626 63.342041,349.862061 63.449463,350.307434 67.043457,350.307434 70.637573,350.307434 74.231567,350.307434 77.825562,350.307434 81.419556,350.307434 85.013550,350.307434 88.607666,350.307434 92.201660,350.307434 95.795532,350.307434 99.389648,350.307434 102.983643,350.307434 106.397949,350.307434" />
				<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="27.325073,322.108215 29.339478,323.625366 31.399414,325.306335 33.473389,327.130676 35.530151,329.077820 37.538208,331.127380 39.466309,333.258911 41.283081,335.451843 42.957153,337.685730 44.457031,339.940125 45.751587,342.194458 46.809326,344.428345 47.598877,346.621277 50.784058,347.982483 53.604248,348.049683 55.910156,347.018738 57.551636,345.085388 58.379028,342.445557 58.242798,339.294983 56.992920,335.829651 54.479736,332.245239 50.553589,328.737610 45.064697,325.502563 37.863159,322.736023 28.799438,320.633789 28.676636,320.756653 28.553711,320.879517 28.430786,321.002380 28.307983,321.125305 28.185059,321.248169 28.062256,321.371033 27.939453,321.493896 27.816528,321.616760 27.693604,321.739624 27.570679,321.862488 27.447876,321.985352 27.331177,322.102051" />
				<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="13.133179,363.209045 15.140747,364.538269 17.182861,366.024902 19.232666,367.649719 21.263306,369.393677 23.247803,371.237366 25.159302,373.161743 26.971069,375.147522 28.656128,377.175537 30.187500,379.226624 31.538452,381.281555 32.682129,383.321106 33.591553,385.326111 36.794312,386.491455 39.584961,386.431946 41.827759,385.343323 43.387207,383.421570 44.127319,380.862366 43.912720,377.861633 42.607666,374.615051 40.076416,371.318665 36.183350,368.168091 30.792725,365.359314 23.768921,363.088135 14.976318,361.550293 14.822754,361.688538 14.669067,361.826721 14.515503,361.964966 14.361938,362.103210 14.208374,362.241455 14.054810,362.379700 13.901123,362.517944 13.747559,362.656128 13.593994,362.794373 13.440430,362.932617 13.286865,363.070862 13.140869,363.202209" />
				<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="63.449463,356.942566 56.250977,372.656860 50.240845,385.782959 45.297485,396.579346 41.299927,405.304810 38.126709,412.217834 35.656250,417.577209 33.767334,421.641418 32.338745,424.669128 31.249023,426.918945 30.376709,428.649536 29.600708,430.119568 28.799438,431.587585 28.321533,432.434448 27.894165,433.140503 27.506348,433.718628 27.147583,434.181519 26.806519,434.542053 26.472534,434.812988 26.134766,435.007080 25.782227,435.137207 25.404175,435.216187 24.989502,435.256714 24.527588,435.271606 24.007446,435.273682 23.316284,435.273682 22.625122,435.273682 21.933960,435.273682 21.242798,435.273682 20.551636,435.273682 19.860474,435.273682 19.169312,435.273682 18.478149,435.273682 17.786987,435.273682 17.095947,435.273682 16.404785,435.273682 15.713623,435.273682 15.713623,435.611572 15.713623,435.949524 15.713623,436.287415 15.713623,436.625305 15.713623,436.963196 15.713623,437.301147 15.713623,437.639038 15.713623,437.976929 15.713623,438.314819 15.713623,438.652710 15.713623,438.990601 15.713623,439.328491 16.694336,439.429321 17.613281,439.548584 18.476562,439.687744 19.290283,439.848450 20.060547,440.032227 20.793335,440.240479 21.494629,440.474915 22.170898,440.737061 22.827759,441.028320 23.471802,441.350464 24.108643,441.704834 24.744751,442.093140 25.696411,442.983215 26.522827,444.344971 27.221313,446.150818 27.789185,448.373291 28.223999,450.984863 28.522949,453.958069 28.683838,457.265259 28.703857,460.878967 28.580688,464.771729 28.311401,468.916016 27.893677,473.284302 27.325073,477.848999 27.493896,479.272949 27.724365,480.593140 28.016113,481.805908 28.369385,482.907288 28.784058,483.893433 29.260254,484.760620 29.797729,485.504883 30.396851,486.122437 31.057251,486.609497 31.779175,486.962097 32.562378,487.176514 33.407227,487.248779 34.915527,487.146240 36.306396,486.843384 37.578979,486.347168 38.732300,485.664795 39.765381,484.803223 40.677002,483.769470 41.466431,482.570679 42.132568,481.213745 42.674316,479.705933 43.090820,478.054199 43.381104,476.265625 43.544189,474.347168 43.608398,470.784546 43.458862,467.456055 43.135254,464.342651 42.677246,461.425110 42.124512,458.684082 41.516724,456.100586 40.893677,453.655273 40.294922,451.329102 39.760010,449.102661 39.328979,446.956909 39.041138,444.872498 38.936401,442.830383 38.964478,441.700256 39.045898,440.524902 39.176636,439.309082 39.352295,438.057617 39.568970,436.775513 39.822388,435.467529 40.108643,434.138550 40.423340,432.793396 40.762573,431.436951 41.122070,430.074097 41.497681,428.709656 41.885376,427.348450 42.733887,424.647278 44.035645,420.806396 45.721313,415.999084 47.721802,410.398926 49.968140,404.179199 52.390991,397.513489 54.921387,390.575134 57.490112,383.537598 60.028198,376.574280 62.466553,369.858704 64.735718,363.564148 66.767090,357.864075 66.490601,357.787292 66.214111,357.710510 65.937622,357.633728 65.661133,357.556946 65.384766,357.480103 65.108276,357.403320 64.831787,357.326538 64.555298,357.249756 64.278809,357.172974 64.002441,357.096130 63.725952,357.019348 63.463379,356.946411" />
				<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="78.009766,424.583862 77.904297,429.810730 77.549072,435.143188 76.886841,440.540894 75.859497,445.963623 74.410156,451.370972 72.480591,456.722656 70.013550,461.978271 66.951416,467.097656 63.236328,472.040405 58.811035,476.766113 53.617676,481.234741 47.598877,485.405701 47.767944,485.605347 47.936890,485.805054 48.105713,486.004639 48.274780,486.204346 48.443726,486.404053 48.612671,486.603699 48.781616,486.803345 48.950439,487.003052 49.119507,487.202759 49.288452,487.402344 49.457397,487.602051 49.626343,487.801697 57.484253,483.840759 64.247192,479.460022 69.995361,474.715759 74.808350,469.664368 78.766357,464.362061 81.949463,458.865234 84.437500,453.230164 86.310547,447.513184 87.648560,441.770569 88.531616,436.058716 89.039673,430.433899 89.252808,424.952454 89.252808,423.539368 89.252808,422.126343 89.252808,420.713379 89.252808,419.300293 89.252808,417.887268 89.252808,416.474243 89.252808,415.061157 89.252808,413.648193 89.252808,412.235107 89.252808,410.822083 89.252808,409.409119 89.252808,407.996033 90.294678,407.831482 91.214355,407.616333 92.020264,407.353882 92.720337,407.047180 93.323364,406.699585 93.837402,406.314270 94.270630,405.894287 94.631714,405.443054 94.928833,404.963623 95.170166,404.459229 95.364136,403.933044 95.519287,403.388306 94.060181,403.234741 92.601074,403.081177 91.141724,402.927551 89.682617,402.773987 88.223511,402.620361 86.764404,402.466797 85.305298,402.313171 83.846191,402.159607 82.387085,402.005981 80.927979,401.852356 79.468872,401.698792 78.009766,401.545227 78.009766,403.465149 78.009766,405.385010 78.009766,407.304871 78.009766,409.224792 78.009766,411.144653 78.009766,413.064514 78.009766,414.984436 78.009766,416.904297 78.009766,418.824158 78.009766,420.744019 78.009766,422.663940 78.009766,424.487793" />
				<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="109.895264,482.641052 110.079468,482.641052 110.263916,482.641052 110.448242,482.641052 110.632446,482.641052 110.816895,482.641052 111.001099,482.641052 111.185425,482.641052 111.369629,482.641052 111.554077,482.641052 111.738281,482.641052 111.922729,482.641052 112.106934,482.641052 113.136475,482.593018 114.183838,482.456787 115.228638,482.243652 116.250488,481.965210 117.228760,481.633179 118.143066,481.258789 118.972900,480.853638 119.697876,480.429321 120.297119,479.997314 120.750732,479.569214 121.037720,479.156494 121.138062,478.770569 121.138062,472.888062 121.138062,467.005493 121.138062,461.123047 121.138062,455.240479 121.138062,449.357910 121.138062,443.475464 121.138062,437.592896 121.138062,431.710388 121.138062,425.827820 121.138062,419.945312 121.138062,414.062805 121.138062,408.180359 122.190674,408.015686 123.138916,407.799805 123.986206,407.535278 124.735596,407.224731 125.390137,406.870605 125.953125,406.475525 126.427856,406.042053 126.817505,405.572754 127.125122,405.070129 127.354126,404.536865 127.507812,403.975403 127.588867,403.388306 126.114502,403.219421 124.639893,403.050415 123.165405,402.881470 121.691040,402.712524 120.216553,402.543579 118.741943,402.374634 117.267578,402.205688 115.793091,402.036743 114.318726,401.867798 112.844116,401.698853 111.369629,401.529907 109.895264,401.360901 109.895264,408.134277 109.895264,414.907654 109.895264,421.680969 109.895264,428.454285 109.895264,435.227661 109.895264,442.000977 109.895264,448.774292 109.895264,455.547607 109.895264,462.320984 109.895264,469.094299 109.895264,475.867676 109.895264,482.302307" />
				<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="179.195190,446.700867 178.995728,446.700867 178.795898,446.700867 178.596191,446.700867 178.396484,446.700867 178.197021,446.700867 177.997314,446.700867 177.797607,446.700867 177.597900,446.700867 177.398315,446.700867 177.198608,446.700867 176.998901,446.700867 176.799194,446.700867 176.373413,449.219482 175.929932,451.773865 175.475464,454.326538 175.016846,456.839844 174.560913,459.276489 174.114136,461.598755 173.683472,463.769165 173.275513,465.750183 172.897339,467.504272 172.555176,468.993896 172.256348,470.181519 172.007324,471.029663 171.868042,471.413086 171.725708,471.738159 171.577393,472.010620 171.421387,472.236206 171.255127,472.420898 171.076172,472.570496 170.882568,472.690796 170.671875,472.787598 170.441528,472.866760 170.189575,472.934204 169.913452,472.995667 169.611206,473.057007 169.354370,473.099365 169.046387,473.134644 168.689697,473.163574 168.286987,473.186707 167.840698,473.204712 167.353516,473.218262 166.827881,473.227966 166.266357,473.234436 165.671631,473.238403 165.046143,473.240417 164.392578,473.241211 163.713379,473.241333 163.191162,473.241333 162.669067,473.241333 162.146606,473.241333 161.624512,473.241333 161.102295,473.241333 160.580078,473.241333 160.057983,473.241333 159.535767,473.241333 159.013428,473.241333 158.491211,473.241333 157.969116,473.241333 157.446899,473.241333 156.800903,473.225525 156.241211,473.176453 155.762207,473.091553 155.358032,472.968262 155.023071,472.803955 154.751343,472.596252 154.537231,472.342407 154.375122,472.039917 154.258789,471.686218 154.183105,471.278809 154.141724,470.815002 154.129272,470.292358 154.129272,465.085693 154.129272,459.878906 154.129272,454.672241 154.129272,449.465515 154.129272,444.258789 154.129272,439.052063 154.129272,433.845337 154.129272,428.638611 154.129272,423.431946 154.129272,418.225159 154.129272,413.018494 154.129272,407.811707 154.970337,407.647034 155.742920,407.431213 156.447510,407.166687 157.085083,406.856079 157.656128,406.501953 158.161011,406.106873 158.600708,405.673401 158.975952,405.204102 159.287109,404.701538 159.534790,404.168213 159.719971,403.606812 159.842896,403.019714 158.429810,402.866150 157.016846,402.712524 155.603882,402.558960 154.190674,402.405396 152.777710,402.251709 151.364624,402.098145 149.951660,401.944580 148.538696,401.790955 147.125610,401.637390 145.712646,401.483765 144.299438,401.330200 142.886475,401.176636 142.886475,407.166687 142.886475,413.156677 142.886475,419.146729 142.886475,425.136780 142.886475,431.126770 142.886475,437.116821 142.886475,443.106812 142.886475,449.096863 142.886475,455.086853 142.886475,461.076904 142.886475,467.066956 142.886475,473.057007 142.924927,474.812378 143.055420,476.395020 143.301270,477.808716 143.685181,479.057251 144.230469,480.144531 144.959839,481.074463 145.896851,481.850708 147.064087,482.477234 148.484863,482.957825 150.182007,483.296387 152.178833,483.496704 154.497803,483.562622 155.250610,483.562622 156.003052,483.562622 156.755615,483.562622 157.508301,483.562622 158.260864,483.562622 159.013428,483.562622 159.766113,483.562622 160.518677,483.562622 161.271240,483.562622 162.023926,483.562622 162.776489,483.562622 163.528931,483.562622 167.261353,483.512878 170.548218,483.364624 173.412720,483.119141 175.877808,482.777588 177.966675,482.341309 179.702026,481.811707 181.107422,481.189819 182.205688,480.477173 183.019653,479.674805 183.572754,478.784241 183.887451,477.806641 183.987305,476.743164 183.970825,476.208801 183.916504,475.708984 183.817383,475.239868 183.666504,474.797729 183.456787,474.378540 183.181030,473.978516 182.832275,473.593933 182.403687,473.220825 181.887939,472.855469 181.278198,472.493835 180.567261,472.132263 179.748169,471.766846 179.702026,469.678040 179.656128,467.589233 179.609985,465.500366 179.563965,463.411499 179.517822,461.322754 179.471680,459.233887 179.425781,457.145020 179.379639,455.056213 179.333496,452.967407 179.287476,450.878601 179.241333,448.789795 179.197632,446.805359" />
				<polygon stroke="#000" stroke-opacity="1" fill="#000" stroke-linecap="round" stroke-width="2" points="141.412109,584.969238 141.412109,584.431641 141.412109,583.894043 141.412109,583.356445 141.412109,582.818970 141.412109,582.281250 141.412109,581.743774 141.412109,581.206177 141.412109,580.668579 141.412109,580.130981 141.412109,579.593506 141.412109,579.055908 141.412109,578.518433 131.029297,578.518433 120.646606,578.518433 110.263916,578.518433 99.881104,578.518433 89.498413,578.518433 79.115601,578.518433 68.733032,578.518433 58.350220,578.518433 47.967529,578.518433 37.584839,578.518433 27.202148,578.518433 16.819336,578.518433 16.819336,574.356201 16.819336,570.193848 16.819336,566.031494 16.819336,561.869263 16.819336,557.706909 16.819336,553.544678 16.819336,549.382324 16.819336,545.220093 16.819336,541.057739 16.819336,536.895386 16.819336,532.733154 16.819336,528.570801 16.251099,528.570801 15.682861,528.570801 15.114502,528.570801 14.546265,528.570801 13.977905,528.570801 13.409668,528.570801 12.841431,528.570801 12.273071,528.570801 11.704834,528.570801 11.136597,528.570801 10.568237,528.570801 10.000000,528.570801 10.000000,533.270630 10.000000,537.970581 10.000000,542.670410 10.000000,547.370239 10.000000,552.070190 10.000000,556.770020 10.000000,561.469971 10.000000,566.169800 10.000000,570.869751 10.000000,575.569580 10.000000,580.269409 10.000000,584.969238 20.951050,584.969238 31.901978,584.969238 42.853027,584.969238 53.804077,584.969238 64.755005,584.969238 75.705933,584.969238 86.656982,584.969238 97.607910,584.969238 108.559082,584.969238 119.510010,584.969238 130.460938,584.969238 140.864502,584.969238" />
			</g>
		</g>
	</g>
</svg>

      
    
      <span class="site-title">MixFlow</span>
    
  </a>

  <nav class="site-nav">
    <h1 class="accessibility hide">Site Navigator</h1>

    <input
      type="checkbox"
      class="nav-trigger"
      id="nav-trigger" />
    <label class="nav-icon" for="nav-trigger">
      <div class="css-icon menu"></div>
      <div class="css-icon close"></div>
    </label><ul class="nav-items">

      

        
        


        
        

      

        
        


        
        
          <li class="page-link" >
            <a href="/artcles.html">

              Artcles
            </a>
          </li>

        

      

        
        


        
        
          <li class="page-link" >
            <a href="/about.html">

              About
            </a>
          </li>

        

      

    </ul>
  </nav>
</header>
<article class="post-content wrapper" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline"> 使用Ruby写一个Racket(Scheme)解释器 </h1>
    <p class="post-meta"><time class="dt-published" datetime="2017-02-20T13:38:05+08:00" itemprop="datePublished">
        Created at: Feb 20, 2017
      </time></p>
  </header>


  <section classs="post-content" itemprop="articleBody">
    <!-- TODO  img center '/assets/images/2017-RacketOnRuby/lambda.svg' 200 'lambda symbol'  -->
<p>如果学习Lisp系语言，可能在后期都会实现一个本语言的解释器<code>interpreter</code>来练个手。</p>
<p>我学的是 Lisp(或者说Scheme)
方言之一的Racket，自己当时能写解释器的时候的确感觉不一样。<br />
毕竟之前也接触过很多语言，基本都是学的语言特性<code>feature</code>，和其流行的package使用(比如web框架)。很少接触过语言实现<code>language implemention</code>的知识。</p>
<p>当自己能写出解释器的时候，感觉到一种新的学习语言的体验。</p>
<p>这篇文章努力做到新手友好，只需要有一定编程知识基础(可能只要懂一门语言)即可阅读。</p>
<p>项目github链接：<a
href="https://github.com/mixflow/RacketOnRuby/">https://github.com/mixflow/RacketOnRuby/</a>
<!--more--></p>
<h2 id="语言相关介绍">语言相关介绍</h2>
<p>Ruby现在还算有些名声，现在的程序员即使没用过的，可能都知道有这门语言。<br />
但是Lisp Scheme可能很多程序员都没听说过，
我当年阅读了别人推荐的《黑客与画家》
这本书才有所了解，在此之前我似乎连Lisp或者Scheme的名字都没见过。
所以有必要先简介一下。</p>
<h3 id="lisp-scheme-racket-是什么">Lisp Scheme Racket 是什么?</h3>
<p>Lisp是一门诞生于上个世纪50年代的语言。其后有很多相同思想的语言，都算得上Lisp家族的，一般被称为Lisp
方言<code>dialect</code>， 其中就包括这里提及的另外两个语言Racket
Scheme。Scheme年代更加久远，影响也大些。Racket相比之下更年轻些。</p>
<p>这篇文章只涉及语言基本简单特征实现，这块哪怕语法上面Racket
Scheme都没什么区别，
所以这里的Racket解释器也可看作Scheme解释器。也就是说能解释执行Scheme代码。</p>
<h3 id="why-use-ruby">Why use Ruby?</h3>
<ol type="1">
<li>当时正好也在学Ruby，所以就用Ruby实现下，纯练手。</li>
<li>这个是第二个编译器实现。最早第一个是当时学习Racket的时候，使用Racket本身实现的，编写了一个<code>metacirclar evaluator</code>，这种方式可以跳过<code>parse</code>步骤（详见紧接着的下文），因为写的代码就已经是AST了（依旧详见下文）。那么用Ruby来实现Racket的话，是需要<code>parser</code>，所以也能再多练一些(虽说parser也没什么复杂的)。</li>
<li>《黑客与画家》中
<em>“如果回到1975年，你声称它(Ruby)是一种有着自己语法的Lisp方言，没有人会提出反对意见。”</em>。<br />
作者认为Ruby也可以视为Lisp的一种方言。那么我反过来通过Lisp的方言来实现Lisp，想法有些古怪，但我认为有点意思。</li>
</ol>
<h2 id="实现一个编程语言通常的步骤">实现一个编程语言通常的步骤</h2>
<p>下面涉及的是一个典型的语言实现<code>language implemention</code>的流程：</p>
<ol type="1">
<li>首先接受一串字符串<code>string</code>，其内容就是用此语言编写的程序。如果该字符串不是符合语法结构<em>syntactically
well-formed</em>（比如关键字拼写错误等），分析器<code>parser</code>会报错。</li>
<li>如果没有上述的语法错误，parser会生成一个树<code>tree</code>来表示程序。这个树一般称为<code>abstract-syntax tree</code>，简称为<code>AST</code>。
<ul>
<li>如果语言有<code>类型检查 type-checking</code>或其他原因，认定AST仍然不是一个合法的程序。
<code>类型检查器 type-checker</code>就会生成错误信息。</li>
<li>如果没有上述错误, AST就会被传递给后续流程。</li>
</ul></li>
<li>实现目标编程语言<code>language B</code>的剩余流程，基本就是如下两种方案。
<ul>
<li>可以用另一门语言<code>language A</code>编写<code>解释器 interpreter</code>来接受使用<code>language B</code>编写的程序，并最终产生结果。这里用来实现interpreter的language
A，有个专门术语称呼：<code>metalanguage</code>。</li>
</ul>
<blockquote>
<p>如果把这个<code>language A</code>程序称作<code>evaluator for B</code>（evaluate中文对应术语一般叫求值，大概意思达到了，但我个人觉得不太准确）或者<code>执行器 executor for B</code>，可能会更直白些。但<code>解释器 interpreter</code>是约定俗成的术语。</p>
</blockquote>
<ul>
<li>另外一种方式再<code>language A</code>写一个<code>编译器 compiler</code>来将<code>language B</code>写的程序生成一个等价<em>equivalent</em>
<code>language C</code>的程序。
然后再使用早已存在的<code>language C</code>语言实现。</li>
</ul>
<blockquote>
<p><code>编译器 compiler</code>可能称为<code>翻译器 translator</code>更好，与interpreter同样的原因，compiler是个普遍使用的术语。</p>
</blockquote></li>
</ol>
<figure>
<img
src="https://upload.wikimedia.org/wikipedia/commons/d/d6/Parser_Flow%D5%B8.gif"
alt="implementing program language workflow from wikipedia parsing" />
<figcaption aria-hidden="true">implementing program language workflow
from <a href="https://en.wikipedia.org/wiki/Parsing">wikipedia
parsing</a></figcaption>
</figure>
<p>另外要说教下，编译器以及解释器只是<strong>编程语言实现方式的特征<em>the
feature of a particular programming language
implementation</em></strong>，而不是编程语言自身的特征<em>the feature of
the programming language</em>。所以“编译性语言” <em>compile
language</em> 或者“解释性语言” <em>interpreter language</em>
的说法<strong>完全没有意义</strong>。完全可以给Lisp,Scheme系语言编写一个compiler(这些语言的解释器实现比较常见)，给C语言编写一个解释器也是完全可行的。</p>
<h2 id="racket基本语法以及parser实现">Racket基本语法以及parser实现</h2>
<p>建议先在<a
href="http://download.racket-lang.org/">Racket官网下载</a>原生Racket以及配套IDE
DrRacket，写Racket或者Scheme程序方便些。
另外本文interpreter实现基本不包含检测和错误处理，所以测试代码最好先在原生Racket里面执行下。</p>
<p>需要快速了解Racket基本语法，推荐此篇快速介绍文章<a
href="https://learnxinyminutes.com/docs/racket/">Learn X in Y minutes,
When x = Racket</a>。</p>
<h3 id="代数运算">代数运算</h3>
<!-- Jekyll, replace code block with caption to Jekyll highlight tag -->
<figure class="highlight code-block">
<figcaption>
<span class="language">lisp</span>
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #575279">(</span><span style="color: #286983">+</span><span style="color: #575279"> </span><span style="color: #D7827E">2</span><span style="color: #575279"> (</span><span style="color: #286983">*</span><span style="color: #575279"> </span><span style="color: #D7827E">2</span><span style="color: #575279"> </span><span style="color: #D7827E">3</span><span style="color: #575279">))</span></span></code></pre>
</figure>
<p>先来个简单的Racket代码例子，上述代码较内层括号<code>(* 2 3)</code>是乘法运算，然后在外层括号内再将上述乘法运算结果加上2。
整个代码等价于数学或者常见编程语言<code>2 + 2 * 3</code>代码意义。</p>
<p>一开始就比较不同寻常，对于此类Racket代码可以看作<code>操作符 operator</code>以及<code>操作数 operand</code>的组合，再用括号包裹。比如<code>(+ 1 1)</code>就可以把<code>+</code>看作操作符。另外可以括号形式的代码嵌套，比如上述先乘后加的代数运算。</p>
<p>这种代码形式，实际非常简单，我们可以给一个更加明确的定义如下节。</p>
<h3 id="racket所有的东西都是">Racket所有的东西都是：</h3>
<p>就两种！</p>
<ol type="1">
<li>一个<code>atom</code>，比如数字<code>3</code>、字符串<code>"hello"</code>、<code>#t</code>、<code>#f</code>、<code>null</code>。也包括一种atom的：<code>识别符 identifier</code>,可以是<code>变量variable</code>,<br />
或者是<code>特别形式special form</code>诸如<code>define</code>、<code>lambda</code>、<code>if</code>。(涉及的名词或者术语，不理解没关系，再后文会一一介绍)</li>
<li>或者是在括号的一序列<em>sequence</em>东西<code>(t1 t2 t3 ... tn)</code>。</li>
</ol>
<p>该定义还有个专门的名称<a
href="https://en.wikipedia.org/wiki/S-expression">S-expression</a>，随着Lisp诞生给出的定义用来描述Lisp。</p>
<p>详说下第二种情况。括号里的第一东西t1，影响余下的序列中的东西。
如果是<code>special form</code>，比如<code>define</code>，以为定义一个东西，要么是变量<em>variable</em>，要么是函数<em>function</em>（<code>lambda</code>）。</p>
<p>如果不是<code>special form</code>，剩余情况一般是函数执行<em>function
call</em>，很多东西在Racket里都是函数，比如加减<code>+</code>和<code>-</code>。</p>
<p>在Racket里括号是很常见的，而且括号作用非常明确。不会遇到<code>f x y</code>是<code>(f x) y</code>还是<code>f (x y)</code>的疑惑。
Racket的括号直接影响着<code>解析parsing</code>，将代码转换成树形结构。实际上Racket代码本身就是树形结构。</p>
<p>如果没有了解过Lisp系语言，大部分人看到一段比较长的代码，都会觉得充满了括号的怪异语法。如果能抛开这些成见，学习使用后实际上能很快适应。</p>
<h3 id="token">Token</h3>
<p>具体到parser中第一步<code>生成token token generator</code>或者叫<code>词汇分析lexical Analysis</code>。可以参照上文实现语言通常流程小节引用的流程图，其中’parser’部分。</p>
<p>这个过程就是把代码字符串分割成多个有意义的符号。这个过程一般使用正则表达式<em>regural
expression</em>简称<em>regex</em>。这些符号专门的术语就是<code>token</code>。</p>
<figure class="highlight code-block">
<figcaption>
<span class="language">ruby</span> write token generator on ruby
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #286983">class</span><span style="color: #575279"> </span><span style="color: #56949F">Racket</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">tokenize</span><span style="color: #797593">(</span><span style="color: #907AA9; font-style: italic">str</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">        str</span><span style="color: #797593">.</span><span style="color: #B4637A; font-style: italic">gsub</span><span style="color: #797593">(</span><span style="color: #EA9D34">&quot;(&quot;</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #EA9D34">&quot;( &quot;</span><span style="color: #797593">)</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> add space after &#39;(&#39;</span></span>
<span class="line"><span style="color: #575279">           </span><span style="color: #797593">.</span><span style="color: #B4637A; font-style: italic">gsub</span><span style="color: #797593">(</span><span style="color: #EA9D34">&quot;)&quot;</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #EA9D34">&quot; )&quot;</span><span style="color: #797593">)</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> add space before &#39;)&#39;</span></span>
<span class="line"><span style="color: #575279">           </span><span style="color: #797593">.</span><span style="color: #575279">split</span><span style="color: #797593">(</span><span style="color: #EA9D34">&quot; &quot;</span><span style="color: #797593">)</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> split string into an array(tokens) base on whitespaces</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">end</span></span>
<span class="line"><span style="color: #286983">end</span></span></code></pre>
</figure>
<p>快速简介下ruby，本文在前言里面提及了面向新手，所以会对于不了解ruby的读者涉及一些介绍，<strong>这部分内容我会用引言块注明（如下），如果不需要，随意跳过。</strong>
不光会有ruby知识，还有一些别的编程知识。</p>
<blockquote>
<p>Ruby是一种<code>动态类型dynamic type</code>
<code>面向对象object oriented</code>编程语言。我定义了一个名叫Racket的<code>类class</code>。
其中定义了一个名叫tokenize的函数。函数有一个’str’的参数，用来接收代码字符串。注意class和method都使用了end明确表明各自代码块的结束部分，ruby里面大部分代码快都需要end结尾，比如if。<br />
另外ruby函数会自动返回最后一个对象。当然你也可以明确<em>explicitly</em>使用<code>return</code>，比如条件（if）分支需要返回的情形。</p>
</blockquote>
<p>代码很简单，先将这对括号”()“内测增加一个空格，方便最后<code>分割split</code>操作。<code>gsub</code>便是替换操作。</p>
<blockquote>
<p><code>str.gsub(...).gsub(...).split(...)</code>这种连着执行函数模式，术语叫做<em>chaining</em>。自己写的代码函数返回对象即可做到。<br />
另外这种风格并不是ruby或者别的某个语言特有的，是一种<code>习惯用法idiom</code>。好处就是少些变量名或者赋值，另外也没必要构造一个大而全方法，完全可以构建更合理多个方法并连续调用从而达到目标。</p>
</blockquote>
下面便测试下上述代码
使用系统的命令行工具到相应的代码目录。确保安装ruby后输入<code>irb</code>命令，定义一段代码string，传入<code>tokenize</code>函数生成token。
<figure class="highlight code-block">
<figcaption>
<span class="language">ruby</span> Test Tokenize in irb
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #286983">c</span><span style="color: #797593">:</span><span style="color: #575279">\</span><span style="color: #575279; font-style: italic">Projects</span><span style="color: #575279">\</span><span style="color: #575279; font-style: italic">RacketOnRuby</span><span style="color: #286983">&gt;</span><span style="color: #575279">irb</span></span>
<span class="line"><span style="color: #575279">irb</span><span style="color: #797593">(</span><span style="color: #575279">main</span><span style="color: #797593">):</span><span style="color: #D7827E">001</span><span style="color: #797593">:</span><span style="color: #D7827E">0</span><span style="color: #286983">&gt;</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">load</span><span style="color: #575279"> </span><span style="color: #EA9D34">&#39;racket.rb&#39;</span></span>
<span class="line"><span style="color: #797593">=&gt;</span><span style="color: #575279"> </span><span style="color: #D7827E">true</span></span>
<span class="line"><span style="color: #575279">irb</span><span style="color: #797593">(</span><span style="color: #575279">main</span><span style="color: #797593">):</span><span style="color: #D7827E">002</span><span style="color: #797593">:</span><span style="color: #D7827E">0</span><span style="color: #286983">&gt;</span><span style="color: #575279"> r </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #56949F">Racket</span><span style="color: #797593">.</span><span style="color: #286983">new</span></span>
<span class="line"><span style="color: #797593">=&gt;</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic">&lt;Racket:0x00000002e67df8&gt;</span></span>
<span class="line"><span style="color: #575279">irb</span><span style="color: #797593">(</span><span style="color: #575279">main</span><span style="color: #797593">):</span><span style="color: #D7827E">003</span><span style="color: #797593">:</span><span style="color: #D7827E">0</span><span style="color: #286983">&gt;</span><span style="color: #575279"> str </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #EA9D34">%{(+ 1</span></span>
<span class="line"><span style="color: #EA9D34">irb(main)</span><span style="color: #797593">:</span><span style="color: #D7827E">004</span><span style="color: #797593">:</span><span style="color: #D7827E">0</span><span style="color: #EA9D34">&quot;      (* 2</span></span>
<span class="line"><span style="color: #EA9D34">irb(main):005:0&quot;</span><span style="color: #575279">         </span><span style="color: #797593">(</span><span style="color: #286983">-</span><span style="color: #575279"> </span><span style="color: #D7827E">7</span><span style="color: #575279"> </span><span style="color: #D7827E">3</span><span style="color: #797593">)))</span></span>
<span class="line"><span style="color: #575279">irb</span><span style="color: #797593">(</span><span style="color: #575279">main</span><span style="color: #797593">):</span><span style="color: #D7827E">006</span><span style="color: #797593">:</span><span style="color: #D7827E">0</span><span style="color: #EA9D34">&quot; }</span></span>
<span class="line"><span style="color: #EA9D34">=&gt; &quot;</span><span style="color: #797593">(</span><span style="color: #286983">+</span><span style="color: #575279"> </span><span style="color: #D7827E">1</span><span style="color: #575279">\n     </span><span style="color: #797593">(</span><span style="color: #286983">*</span><span style="color: #575279"> </span><span style="color: #D7827E">2</span><span style="color: #575279">\n        </span><span style="color: #797593">(</span><span style="color: #286983">-</span><span style="color: #575279"> </span><span style="color: #D7827E">7</span><span style="color: #575279"> </span><span style="color: #D7827E">3</span><span style="color: #797593">)))</span><span style="color: #575279">\n</span><span style="color: #EA9D34">&quot;</span></span>
<span class="line"><span style="color: #EA9D34">irb(main):007:0&gt; p r.tokenize(str)</span></span>
<span class="line"><span style="color: #EA9D34">[&quot;</span><span style="color: #797593">(</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #286983">+</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #D7827E">1</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #797593">(</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #286983">*</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #D7827E">2</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #797593">(</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #286983">-</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #D7827E">7</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #D7827E">3</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #797593">)</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #797593">)</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #797593">)</span><span style="color: #EA9D34">&quot;]</span></span>
<span class="line"><span style="color: #EA9D34">=&gt; [&quot;</span><span style="color: #797593">(</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #286983">+</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #D7827E">1</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #797593">(</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #286983">*</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #D7827E">2</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #797593">(</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #286983">-</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #D7827E">7</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #D7827E">3</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #797593">)</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #797593">)</span><span style="color: #EA9D34">&quot;, &quot;</span><span style="color: #797593">)</span><span style="color: #EA9D34">&quot;]</span></span></code></pre>
</figure>
<blockquote>
<ul>
<li>第1行（最左边的行号）<code>irb</code>进入ruby
REPL。没听过REPL，先粗略认为REPL就是专门执行代码的命令工具。下文<a
href="#工具repl-read-eval-print-loop">REPL章节</a>会详细的涉及，因为我们实现Racket也要写个Racket的REPL，来方便测试。</li>
<li>第2行加载包含Racket class的相应的ruby file。
我的ruby文件名就叫做racket.rb。</li>
<li>第4行创建一个Racket的对象<code>实例instance</code>。该实例将来调用相应的函数进行<code>tokenize</code>以及后续的操作。Ruby的语法syntax，很多时候执行函数都可以省略括号，比如此处创建对象的时候调用<code>new</code>构造函数，可选写法：<code>Racket.new()</code>两种代码等价的。</li>
<li>6行到9行，定义了变量名为<code>str</code>的code string。
<code>%{...}</code>是ruby定义多行字符串的一种语法syntax。</li>
<li>第10行，irb会自动输出之前代码执行结果返回的对象（包括之前的3、5行）。其中把换行转义成了’’输出在一行。</li>
<li>第11行，调用<code>tokenize</code>函数，并传入上一步定义的string。并打印输出结果即tokens</li>
</ul>
</blockquote>
<blockquote>
<p>可以把上述命令行中的ruby测试代码放入专门的rb文件，这样就无需在每次重新测试再敲代码。例如github项目中的<em>example.rb</em>，直接系统命令行执行<code>ruby example.rb</code></p>
</blockquote>
<p>此前代码，在<code>tokenize</code>函数多了第一步处理是把多个空白符转化成单个隔空”
“，然而写这篇文章的时候，我重新审查了下代码，并不需要多此一举。多余的代码：<code>str.gsub(/\s{2,}/, " ")</code></p>
<p>原因是<code>split</code>方法传入单个空格字符串的时候，会基于空白符<em>whitespace</em>分割，而且会忽略余下的紧挨着的空白符。<a
href="#fn1" class="footnote-ref" id="fnref1"
role="doc-noteref"><sup>1</sup></a></p>
<p>token生成好了，下面便是分析token并生成AST了。</p>
<h2 id="abstract-syntax-tree-parse-tree">Abstract Syntax Tree (Parse
Tree)</h2>
<figure class="highlight code-block">
<figcaption>
<span class="language">ruby</span>
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">generate_ast</span><span style="color: #797593">(</span><span style="color: #907AA9; font-style: italic">tokens</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">aux</span><span style="color: #797593">(</span><span style="color: #907AA9; font-style: italic">tokens</span><span style="color: #575279">, </span><span style="color: #907AA9; font-style: italic">acc</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">if</span><span style="color: #575279"> tokens</span><span style="color: #797593">.</span><span style="color: #575279">empty?</span></span>
<span class="line"><span style="color: #797593">            </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> no tokens left, return result</span></span>
<span class="line"><span style="color: #575279">            </span><span style="color: #286983">return</span><span style="color: #575279"> acc</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #575279">        token </span><span style="color: #286983">=</span><span style="color: #575279"> tokens</span><span style="color: #797593">.</span><span style="color: #575279">shift </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> get first token</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">if</span><span style="color: #575279"> </span><span style="color: #EA9D34">&#39;(&#39;</span><span style="color: #575279"> </span><span style="color: #286983">==</span><span style="color: #575279"> token </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> start one s-expression</span></span>
<span class="line"><span style="color: #575279">            sub_ast </span><span style="color: #286983">=</span><span style="color: #575279"> aux tokens</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #797593">[]</span></span>
<span class="line"><span style="color: #575279">            acc</span><span style="color: #797593">.</span><span style="color: #575279">push sub_ast</span></span>
<span class="line"></span>
<span class="line"><span style="color: #575279">            aux</span><span style="color: #797593">(</span><span style="color: #575279">tokens</span><span style="color: #797593">,</span><span style="color: #575279">  acc</span><span style="color: #797593">)</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> recursive call to continue handling rest tokens</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">elsif</span><span style="color: #575279"> </span><span style="color: #EA9D34">&#39;)&#39;</span><span style="color: #575279"> </span><span style="color: #286983">==</span><span style="color: #575279"> token </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> end one s-expression</span></span>
<span class="line"><span style="color: #575279">            </span><span style="color: #286983">return</span><span style="color: #575279"> acc</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">else</span></span>
<span class="line"><span style="color: #575279">            acc</span><span style="color: #797593">.</span><span style="color: #575279">push atom</span><span style="color: #797593">(</span><span style="color: #575279">token</span><span style="color: #797593">)</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> convent current token to atom</span></span>
<span class="line"><span style="color: #575279">            aux tokens</span><span style="color: #797593">,</span><span style="color: #575279"> acc </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> recursive</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">end</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #575279">    aux tokens</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #797593">[]</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> initial call helper</span></span>
<span class="line"><span style="color: #286983">end</span></span></code></pre>
</figure>
<p>真正起作用的是<code>generate_ast</code>内部定义<code>aux</code>（<em>auxiliary辅助</em>,
<em>helper</em>）的方法，处理tokens，其参数<code>acc</code>（<em>accumulator累加器</em>）存放的处理得到的AST。</p>
<p>主要使用<code>递归 recursion</code>从左到右处理<code>tokens</code>里面的每一个token：</p>
<ul>
<li>tokens为空的时候，返回<code>acc</code>即AST结果。</li>
<li>当遇到左括号时，说明遇到一个s-expression的序列，递归调用<code>aux</code>方法的时候给<code>acc</code>参数传入一个新的空array（上述第10行代码），用来存储这部分subdivision
s-expression序列对应的AST结果。<br />
第11行，递归调用处理完返回<code>subdivision acc</code>结果，追加到原来acc后面。</li>
<li>当遇到右括号的时候，说明s-expression的结束，返回结果<code>acc</code>，对应上一点的<code>subdivsion acc</code>。<br />
</li>
<li>剩余其他情况，将token转化为atom，紧接的下文涉及atom实现细节。</li>
</ul>
<p>实际<code>generate_ast</code>方法简化下就是匹配括号的代码，包括嵌套<em>nested</em>结构。</p>
<blockquote>
<p>上述代码并没有检测括号是否匹配，因为需要文章简洁，这里只贴出不检测括号的代码，github上面的源文件里面包含有完整的括号检测。<br />
racket里面除了可以使用圆括号()，也可以使用方括号[]，两者功能作用没有区别，编码习惯在某些地方会使用[]，但不遵循也不会有什么实质影响。唯一注意的就是要对应的括号匹配，不能混用，比如<code>(+ 1 1]</code>就是语法不正确。</p>
</blockquote>
<h3 id="atom">Atom</h3>
<figure class="highlight code-block">
<figcaption>
<span class="language">ruby</span> s-expression atom
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">atom</span><span style="color: #797593">(</span><span style="color: #907AA9; font-style: italic">token</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">    str_part </span><span style="color: #286983">=</span><span style="color: #575279"> token</span><span style="color: #797593">[</span><span style="color: #EA9D34">/^&quot;</span><span style="color: #797593">(</span><span style="color: #EA9D34">.*</span><span style="color: #797593">)</span><span style="color: #EA9D34">&quot;$/</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #D7827E">1</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> try match string(start and end with &quot;)</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">if</span><span style="color: #575279"> </span><span style="color: #286983">not</span><span style="color: #575279"> str_part</span><span style="color: #797593">.</span><span style="color: #575279">nil?</span></span>
<span class="line"><span style="color: #575279">        str_part</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">elsif</span><span style="color: #575279"> token</span><span style="color: #797593">[</span><span style="color: #EA9D34">/</span><span style="color: #797593">(</span><span style="color: #EA9D34">?=</span><span style="color: #797593">(</span><span style="color: #286983">\.</span><span style="color: #EA9D34">|</span><span style="color: #797593">[</span><span style="color: #286983">eE</span><span style="color: #797593">]))(</span><span style="color: #286983">\.\d</span><span style="color: #EA9D34">+</span><span style="color: #797593">)</span><span style="color: #EA9D34">?</span><span style="color: #797593">([</span><span style="color: #286983">eE</span><span style="color: #797593">][</span><span style="color: #286983">+-</span><span style="color: #797593">]</span><span style="color: #EA9D34">?</span><span style="color: #286983">\d</span><span style="color: #EA9D34">+</span><span style="color: #797593">)</span><span style="color: #EA9D34">?$/</span><span style="color: #797593">]</span><span style="color: #575279">  </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> decimal</span></span>
<span class="line"><span style="color: #575279">        token</span><span style="color: #797593">.</span><span style="color: #575279">to_f</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">elsif</span><span style="color: #575279"> token</span><span style="color: #797593">[</span><span style="color: #EA9D34">/^</span><span style="color: #286983">\d</span><span style="color: #EA9D34">+$/</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> integer</span></span>
<span class="line"><span style="color: #575279">        token</span><span style="color: #797593">.</span><span style="color: #575279">to_i</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">else</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> symbol</span></span>
<span class="line"><span style="color: #575279">        token</span><span style="color: #797593">.</span><span style="color: #575279">to_sym</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">end</span></span>
<span class="line"><span style="color: #286983">end</span></span></code></pre>
</figure>
<p>刚才上文我们已经处理了s-expression序列，即<a
href="#racket所有的东西都是">上文提及s-expression</a>第二种情形。此处<code>atom</code>为第一种情况，具体又有细分，可能是string、数字、也有可能是<code>identifier</code>。对应代码中<code>if</code>语句各个分支，通过正则式尝试匹配<code>token</code>（Ruby
string对象）：</p>
<ol type="1">
<li><p>在Racket中头尾各一个双引号<code>"</code>来包含字符串。第一个if便是通过正则式匹配首尾”，如果的确是string，其中间部分取出就是对应的Ruby
string类型的对象。</p></li>
<li><p>第二个if分支判断是否为浮点数。这里的正则式看起来很复杂，简单代替方案是仅仅匹配小数点（正则式为
<code>/\.\d+$/</code>）。这里复杂的正则式是除了用来匹配小数外，还能匹配指数<em>exponential</em>，Ruby中指数类似1e5也算作浮点数(等同于10000.0，Racket中也是同样的)。to_f便是将string转化为float浮点数的方法。这里举出4个数<code>.003</code>
<code>0.5</code> <code>32e3</code>
<code>.24e5</code>，这些都是浮点数，我们的正则式便是能够匹配出对应小数点部分以及指数部分，测试代码如下，第一行这四个数尝试使用该正则式匹配，第二行是匹配部分的结果:</p>
<figure class="highlight code-block">
<figcaption>
<p><span class="language">ruby</span> decimal and exponential</p>
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #575279">    </span><span style="color: #797593">[</span><span style="color: #EA9D34">&#39;.003&#39;</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #EA9D34">&#39;0.5&#39;</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #EA9D34">&#39;32e3&#39;</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #EA9D34">&#39;.24e5&#39;</span><span style="color: #797593">].</span><span style="color: #575279">map</span><span style="color: #797593">{|</span><span style="color: #575279; font-style: italic">num</span><span style="color: #797593">|</span><span style="color: #575279"> num</span><span style="color: #797593">[</span><span style="color: #EA9D34">/</span><span style="color: #797593">(</span><span style="color: #EA9D34">?=</span><span style="color: #797593">(</span><span style="color: #286983">\.</span><span style="color: #EA9D34">|</span><span style="color: #797593">[</span><span style="color: #286983">eE</span><span style="color: #797593">]))(</span><span style="color: #286983">\.\d</span><span style="color: #EA9D34">+</span><span style="color: #797593">)</span><span style="color: #EA9D34">?</span><span style="color: #797593">([</span><span style="color: #286983">eE</span><span style="color: #797593">][</span><span style="color: #286983">+-</span><span style="color: #797593">]</span><span style="color: #EA9D34">?</span><span style="color: #286983">\d</span><span style="color: #EA9D34">+</span><span style="color: #797593">)</span><span style="color: #EA9D34">?$/</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #797593">}</span></span>
<span class="line"><span style="color: #797593">    </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> =&gt; [&quot;.003&quot;, &quot;.5&quot;, &quot;e3&quot;, &quot;.24e5&quot;]</span></span></code></pre>
</figure>
<blockquote>
<p>Ruby Array的map方法，是将其中每个元素都进行block中处理。
<code>{ |num| ...}</code>形式就是block，此处Array.map会往block的num参数
传入单个元素。</p>
</blockquote></li>
<li><p>第三个if分支，尝试匹配是否为整数。to_i便把string是转化整数<em>integer</em>的方法</p></li>
<li><p>最后一个else分支，剩下情况可能是变量名或者special
form比如<code>lambda</code> <code>define</code>等。最后转化为Ruby
<code>符号Symbol</code>类型。所谓symbol类似string，symbol为不可变<code>immutable</code>，而且其值一样的话，就是同一个对象。</p>
<blockquote>
<p>Ruby中symbol是以<code>:</code>作为开头，例如<code>:hello</code>。两两比对的时候symbol效率更高。不像string一个一个字符<em>char</em>进行比对，symbol直接比对两者在内存中是否为同一个对象。</p>
</blockquote></li>
</ol>
<p>到此为止，实现了生成AST的部分，下面就要涉及interpreter部分了。</p>
<h2
id="eval方法实现executorinterpreter">eval方法实现executor(interpreter)</h2>
<p>有些表达式<em>expression</em>中会包含变量<em>variable</em>，求值<em>evaluate</em>这些表达式就需要<code>environment</code>，通过variable获得对应值<em>vaLue</em>。</p>
<p>environment的实现是<code>metalanguage</code>的一部分，metalanguage这里就是我们使用的Ruby。这里使用hash数据结构来代表environment。</p>
<h3 id="完成代数运算eval">完成代数运算eval</h3>
文章一开始的提及的代数运算的Racket代码<code>(+ 1 (* 2 3))</code>，首先将其实现:
<figure class="highlight code-block">
<figcaption>
<span class="language">ruby</span> eval algebra operators
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">initialize</span><span style="color: #797593">()</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #797593; font-style: italic">@</span><span style="color: #575279; font-style: italic">env</span><span style="color: #575279"> </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #797593">{</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #797593">:</span><span style="color: #286983">+</span><span style="color: #575279"> </span><span style="color: #797593">=&gt;</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">lambda</span><span style="color: #797593">{|</span><span style="color: #575279; font-style: italic">x</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #575279; font-style: italic">y</span><span style="color: #797593">|</span><span style="color: #575279"> x</span><span style="color: #286983">+</span><span style="color: #575279">y</span><span style="color: #797593">},</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #797593">:</span><span style="color: #286983">*</span><span style="color: #575279"> </span><span style="color: #797593">=&gt;</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">lambda</span><span style="color: #797593">{|</span><span style="color: #575279; font-style: italic">x</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #575279; font-style: italic">y</span><span style="color: #797593">|</span><span style="color: #575279"> x</span><span style="color: #286983">*</span><span style="color: #575279">y</span><span style="color: #797593">}</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #797593">}</span></span>
<span class="line"><span style="color: #286983">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">eval</span><span style="color: #797593">(</span><span style="color: #907AA9; font-style: italic">exp</span><span style="color: #575279">, </span><span style="color: #907AA9; font-style: italic">env</span><span style="color: #286983">=</span><span style="color: #797593; font-style: italic">@</span><span style="color: #575279; font-style: italic">env</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">if</span><span style="color: #575279"> exp</span><span style="color: #797593">.</span><span style="color: #575279">is_a? </span><span style="color: #575279; font-style: italic">Numeric</span></span>
<span class="line"><span style="color: #575279">        exp </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> is a number(integer and float) return itself</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">elsif</span><span style="color: #575279"> exp</span><span style="color: #797593">[</span><span style="color: #D7827E">0</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #286983">==</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">+</span><span style="color: #575279"> </span><span style="color: #286983">or</span><span style="color: #575279"> exp</span><span style="color: #797593">[</span><span style="color: #D7827E">0</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #286983">==</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">*</span></span>
<span class="line"><span style="color: #575279">        env</span><span style="color: #797593">[</span><span style="color: #575279"> exp</span><span style="color: #797593">[</span><span style="color: #D7827E">0</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #797593">].</span><span style="color: #575279">call</span><span style="color: #797593">(</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">eval</span><span style="color: #797593">(</span><span style="color: #575279">exp</span><span style="color: #797593">[</span><span style="color: #D7827E">1</span><span style="color: #797593">],</span><span style="color: #575279"> env</span><span style="color: #797593">),</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">eval</span><span style="color: #797593">(</span><span style="color: #575279">exp</span><span style="color: #797593">[</span><span style="color: #D7827E">2</span><span style="color: #797593">],</span><span style="color: #575279"> env</span><span style="color: #797593">)</span><span style="color: #575279"> </span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">else</span></span>
<span class="line"><span style="color: #575279">        results </span><span style="color: #286983">=</span><span style="color: #575279"> exp</span><span style="color: #797593">.</span><span style="color: #575279">map </span><span style="color: #797593">{</span><span style="color: #575279"> </span><span style="color: #797593">|</span><span style="color: #575279; font-style: italic">subexp</span><span style="color: #797593">|</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">eval</span><span style="color: #797593">(</span><span style="color: #575279">subexp</span><span style="color: #797593">,</span><span style="color: #575279"> env</span><span style="color: #797593">)</span><span style="color: #575279"> </span><span style="color: #797593">}</span></span>
<span class="line"><span style="color: #575279">        results</span><span style="color: #797593">[</span><span style="color: #286983">-</span><span style="color: #D7827E">1</span><span style="color: #797593">]</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">end</span></span>
<span class="line"><span style="color: #286983">end</span></span></code></pre>
</figure>
<p>增加了两个方法<code>initialize</code>以及<code>eval</code>。</p>
<blockquote>
<p><code>initialize</code>方法是Ruby的对象的构造器方法，即<code>new</code>对象时候会调用该方法，该方法可以省略，我们之前<code>parser</code>部分就不需要构造方法，所以就一直没有<code>initialize</code>。</p>
</blockquote>
<blockquote>
<p>Ruby中<code>@</code>开头的变量是<code>实例变量instance variable</code>，作用范围为单个对象实例内，所有该对象的内部方法都可以访问到。<br />
另外<code>@@</code>两个at符号开头是<code>类变量class variable</code>，顾名思义即同一个类创建的所有对象实例
都共享同一个类变量。<br />
Ruby<strong>不需要提前声明variable</strong>，赋值一个之前不存在的variable，会自动创建该variable。</p>
</blockquote>
<p>其中<code>initialize</code>方法中，定义了一个<code>@env</code>实例变量，并赋值了一个hash。之前说过，在Racket中代数运算看作函数，metalanguage(Ruby)实现了<code>+</code>和<code>*</code>各自对应的lambda（或者叫Proc
object，ruby的术语），lambda可以看作匿名函数，该匿名函数接受两个参数<code>x``y</code>，将其相加或者相乘。</p>
<p>后文还会详细介绍lambda，因为我们也要实现Racket的lambda，Racket和Ruby的lambda基本是同一个东西，仅语法有区别。</p>
<p>eval方法依旧含有recursive call，递归很适合处理嵌套形式，处理
子表达式<em>subexpression</em>，需要返回的情形结果可能有差异。</p>
<ul>
<li>第一个if条件分支，判断如果表达式只是纯粹数字，那么不需要额外处理，返回自身。</li>
<li>第二个条件分支，涉及expression的首个thing如果是<code>:+</code>或者<code>:*</code>，<code>env[ exp[0] ]</code>则去environment中查找对应的函数。调用传入expression紧接着的2个thing，作为两个操作数。注意此处都会先执行下eval方法，因为可能是需要处理的subexpression，同时也是使用的同样的environment。</li>
<li>最后一个条件分支，之前实现的parser实际上可以处理多个expression，例如<code>(+ 1 1) (* 2 2) (+ 3 4)</code>这样的代码中包含三个expression，parser处理完后的AST为<code>[[:+, 1, 1], [:*, 2, 2], [:+, 3, 4]]</code>，包含三个expression处理后的AST的array。即使只有一个expression，parser处理后也是一个长度为1的array，例如该章开始提到的代码，parse后的结果：<code>[ [:+ 1 [:* 2 3]] ]</code>。<br />
这里，我返回的最后一个结果。当然也可以直接放回<code>results</code>结果array。自己写的interpreter，细节由自己定义。</li>
</ul>
<h3 id="function-call以及variables-in-environment">Function
call以及Variables in environment</h3>
上面处理加和乘，可以改写成处理任何方法的通用办法.
<figure class="highlight code-block">
<figcaption>
<span class="language">ruby</span> updated call functions
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">eval_expressions</span><span style="color: #797593">(</span><span style="color: #907AA9; font-style: italic">exps</span><span style="color: #575279">, </span><span style="color: #907AA9; font-style: italic">env</span><span style="color: #286983">=</span><span style="color: #797593; font-style: italic">@</span><span style="color: #575279; font-style: italic">env</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">    results </span><span style="color: #286983">=</span><span style="color: #575279"> exps</span><span style="color: #797593">.</span><span style="color: #575279">map </span><span style="color: #797593">{</span><span style="color: #575279"> </span><span style="color: #797593">|</span><span style="color: #575279; font-style: italic">one_exp</span><span style="color: #797593">|</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">eval</span><span style="color: #797593">(</span><span style="color: #575279">one_exp</span><span style="color: #797593">,</span><span style="color: #575279"> env</span><span style="color: #797593">)</span><span style="color: #575279"> </span><span style="color: #797593">}</span></span>
<span class="line"><span style="color: #575279">    results</span><span style="color: #797593">[</span><span style="color: #286983">-</span><span style="color: #D7827E">1</span><span style="color: #797593">]</span></span>
<span class="line"><span style="color: #286983">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">eval</span><span style="color: #797593">(</span><span style="color: #907AA9; font-style: italic">exp</span><span style="color: #575279">, </span><span style="color: #907AA9; font-style: italic">env</span><span style="color: #286983">=</span><span style="color: #797593; font-style: italic">@</span><span style="color: #575279; font-style: italic">env</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">lookup_env</span><span style="color: #797593">(</span><span style="color: #907AA9; font-style: italic">env</span><span style="color: #575279">, </span><span style="color: #907AA9; font-style: italic">var</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">        error_no_var </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #EA9D34">&quot;undefined: </span><span style="color: #286983">\&quot;</span><span style="color: #EA9D34">%s</span><span style="color: #286983">\&quot;</span><span style="color: #EA9D34">&quot;</span><span style="color: #575279"> </span><span style="color: #286983">%</span><span style="color: #575279"> var</span></span>
<span class="line"><span style="color: #575279">        val </span><span style="color: #286983">=</span><span style="color: #575279"> env</span><span style="color: #797593">[</span><span style="color: #575279">var</span><span style="color: #797593">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">if</span><span style="color: #575279"> val</span><span style="color: #797593">.</span><span style="color: #575279">nil?</span></span>
<span class="line"><span style="color: #575279">            </span><span style="color: #286983">raise</span><span style="color: #575279"> error_no_var</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">else</span></span>
<span class="line"><span style="color: #575279">            </span><span style="color: #286983">return</span><span style="color: #575279"> val</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">end</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">if</span><span style="color: #575279"> exp</span><span style="color: #797593">.</span><span style="color: #575279">is_a? </span><span style="color: #575279; font-style: italic">Numeric</span></span>
<span class="line"><span style="color: #575279">        exp </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> is a number(integer and float) return itself</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">elsif</span><span style="color: #575279"> exp</span><span style="color: #797593">.</span><span style="color: #575279">is_a? </span><span style="color: #575279; font-style: italic">Symbol</span></span>
<span class="line"><span style="color: #575279">        lookup_env</span><span style="color: #797593">(</span><span style="color: #575279">env</span><span style="color: #797593">,</span><span style="color: #575279"> exp</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">else</span></span>
<span class="line"><span style="color: #575279">        operator </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">eval</span><span style="color: #797593">(</span><span style="color: #575279">exp</span><span style="color: #797593">[</span><span style="color: #D7827E">0</span><span style="color: #797593">],</span><span style="color: #575279"> env</span><span style="color: #797593">)</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> first thing of s-expression sequence.</span></span>
<span class="line"><span style="color: #575279">        operands </span><span style="color: #286983">=</span><span style="color: #575279"> exp</span><span style="color: #797593">[</span><span style="color: #D7827E">1</span><span style="color: #797593">..</span><span style="color: #286983">-</span><span style="color: #D7827E">1</span><span style="color: #797593">].</span><span style="color: #575279">map </span><span style="color: #797593">{|</span><span style="color: #575279; font-style: italic">sub_exp</span><span style="color: #797593">|</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">eval</span><span style="color: #797593">(</span><span style="color: #575279">sub_exp</span><span style="color: #797593">,</span><span style="color: #575279"> env</span><span style="color: #797593">)</span><span style="color: #575279"> </span><span style="color: #797593">}</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> the rest things of sequence</span></span>
<span class="line"><span style="color: #575279">        operator</span><span style="color: #797593">.</span><span style="color: #575279">call </span><span style="color: #286983">*</span><span style="color: #575279">operands</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">end</span></span>
<span class="line"><span style="color: #286983">end</span></span></code></pre>
</figure>
<p>将处理多个expression的办法提炼成<code>eval_expressions</code>方法。这样的话parse处理完后的AST(结果都是array，一个或多个expression)就先调用<code>eval_expressions</code>处理。而<code>eval</code>只用来处理单个expression。这样处理的理由，如果包含在<code>eval</code>一个条件分支的话，会与单个expression处理混乱（因为同样使用array来存放s-expression）。</p>
<p><code>else</code>分支就是处理方法调用，expression第一个thing也执行了<code>eval</code>。这样就可以处理这样的<code>( (if #t + *) 2 3 )</code>Racket代码（第一个thing也可能是sub
expresion）。</p>
<blockquote>
<p><code>operator.call *operands</code>中<code>oprands</code>是array，其前面<code>*</code>是<code>splat operator</code>。作用是将数组拆开，每个元素对应到单个参数。反过来，在函数参数声明时候也可以使用<code>*</code>，作用也是相反的，将传入的单个参数值组成array。</p>
</blockquote>
<p>另外，多了处理symbol
atom的步骤，一般symbol为variable的时候，就需要到environment查找对应的value，即<code>lookup_env</code>方法。该方法很简单，就是通过variable作为key查找environment对应的值，没有variable的话就抛出一个简单错误提示该variable没被定义。</p>
如果完整代数运算，除法和减法<code>:/</code>，<code>:-</code>可以类似上面写法。但是重复劳动了，用程序来做重复的事。另外还有一点需要改进，Racket中代数运算符，可以接受多个数字，进行累积运算。<br />
例如<code>(+ 1 4 5 7)</code>执行结果为<code>17</code>，<code>(* 2 3 4)</code>执行结果为<code>24</code>。
<figure class="highlight code-block">
<figcaption>
<span class="language">ruby</span> updated algebra
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #575279; font-style: italic">ALGEBRA_OPERATORS</span><span style="color: #575279"> </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #797593">[:</span><span style="color: #286983">+</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">-</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">*</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">/</span><span style="color: #797593">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">initialize</span><span style="color: #797593">()</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #797593; font-style: italic">@</span><span style="color: #575279; font-style: italic">env</span><span style="color: #575279"> </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #797593">{</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #797593">}</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #56949F">ALGEBRA_OPERATORS</span><span style="color: #797593">.</span><span style="color: #575279">map </span><span style="color: #286983">do</span><span style="color: #575279"> </span><span style="color: #797593">|</span><span style="color: #575279; font-style: italic">opt</span><span style="color: #797593">|</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #797593; font-style: italic">@</span><span style="color: #575279; font-style: italic">env</span><span style="color: #797593">[</span><span style="color: #575279">opt</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">lambda</span><span style="color: #797593">{</span><span style="color: #575279"> </span><span style="color: #797593">|</span><span style="color: #286983">*</span><span style="color: #575279; font-style: italic">operands</span><span style="color: #797593">|</span><span style="color: #575279"> operands</span><span style="color: #797593">.</span><span style="color: #575279">inject</span><span style="color: #797593">(</span><span style="color: #575279">opt</span><span style="color: #797593">)</span><span style="color: #575279"> </span><span style="color: #797593">}</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">end</span></span>
<span class="line"><span style="color: #286983">end</span></span></code></pre>
</figure>
<p>改写成上述代码，通过程序往environment增加每个代数运算符对应的lambda函数。看到这似乎炫技嫌疑，但实际后面也有相同的思想的实现，比较大小的comparison
operator也是类似的（也是能接受多个参数）</p>
<p>至此<code>eval</code>的大致结构功能如此。后文涉及的新的Racket
feature，就是往<code>eval</code>增加更多情况的处理，方式可能是增加条件分支，也有可能是往environment中增加函数（可以看作Racket自带的函数）。</p>
<h3 id="工具repl-read-eval-print-loop">工具REPL,
Read-Eval-Print-Loop</h3>
在继续完备eval方法之前，首先实现REPL这个工具，让调试Racket代码更加方便。就如之前执行Ruby代码的<code>irb</code>。
REPL全称read-eval-print-loop顾名思义，其过程: 读取code -&gt;
eval求值这段代码 -&gt; 输出结果 -&gt; 循环上述步骤。
<figure class="highlight code-block">
<figcaption>
<span class="language">ruby</span> REPL
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">repl</span><span style="color: #797593">(</span><span style="color: #907AA9; font-style: italic">prompt</span><span style="color: #286983">=</span><span style="color: #EA9D34">&#39;RacketOnRb &gt;&gt;&#39;</span><span style="color: #575279">, </span><span style="color: #907AA9; font-style: italic">output_prompt</span><span style="color: #286983">=</span><span style="color: #EA9D34">&quot;=&gt;&quot;</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">while</span><span style="color: #575279"> </span><span style="color: #D7827E">true</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #B4637A; font-style: italic">print</span><span style="color: #575279"> prompt</span></span>
<span class="line"><span style="color: #575279">        code </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">gets</span></span>
<span class="line"></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">begin</span></span>
<span class="line"><span style="color: #575279">            ast </span><span style="color: #286983">=</span><span style="color: #575279"> parse</span><span style="color: #797593">(</span><span style="color: #575279">code</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">            result </span><span style="color: #286983">=</span><span style="color: #575279"> eval_expressions</span><span style="color: #797593">(</span><span style="color: #575279">ast</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">            </span><span style="color: #B4637A; font-style: italic">puts</span><span style="color: #575279"> output_prompt </span><span style="color: #286983">+</span><span style="color: #575279"> result</span><span style="color: #797593">.</span><span style="color: #575279">to_s</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">rescue</span><span style="color: #575279"> </span><span style="color: #575279; font-style: italic">Exception</span><span style="color: #575279"> </span><span style="color: #797593">=&gt;</span><span style="color: #575279"> e</span></span>
<span class="line"><span style="color: #575279">            </span><span style="color: #B4637A; font-style: italic">puts</span><span style="color: #575279"> e</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">end</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">end</span></span>
<span class="line"><span style="color: #286983">end</span></span></code></pre>
</figure>
<p>相当直接的代码，一个无限循环，接受console输入Racket代码，然后解析执行代码，即之前描述的过程。<br />
执行<code>parse</code>，<code>eval</code>这部分时，会尝试捕获异常，如果有异常只是打印出来，继续loop。这样就能避免出错整个program终止，需要重新执行该repl方法。</p>
<h3 id="定义变量variable">定义变量variable</h3>
前面已经完成查询variable对应的value的方法。相应我们需要实现定义变量，其语法<code>(define &lt;var&gt; &lt;exp&gt;)</code>。
<figure class="highlight code-block">
<figcaption>
<span class="language">ruby</span>
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #286983">elsif</span><span style="color: #575279"> exp</span><span style="color: #797593">[</span><span style="color: #D7827E">0</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #286983">==</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">define</span></span>
<span class="line"><span style="color: #575279">    _</span><span style="color: #797593">,</span><span style="color: #575279"> var</span><span style="color: #797593">,</span><span style="color: #575279"> value_exp </span><span style="color: #286983">=</span><span style="color: #575279"> exp</span></span>
<span class="line"><span style="color: #575279">    env</span><span style="color: #797593">[</span><span style="color: #575279">var</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">eval</span><span style="color: #797593">(</span><span style="color: #575279"> value_exp</span><span style="color: #797593">,</span><span style="color: #575279"> env </span><span style="color: #797593">)</span></span></code></pre>
</figure>
<p>放置于处理function call分支之前即可。</p>
<h3 id="条件判断if语句">条件判断、if语句</h3>
<p>Racket中用<code>#t</code>和<code>#f</code>表示true和false。</p>
Racket
if的语法：<code>(if &lt;test-exp&gt; &lt;then-exp&gt; &lt;else-exp&gt;)</code>当<test-exp>执行结果不是<code>#f</code>的时候，执行<code>&lt;then-exp&gt;</code>分支，否则执行<code>&lt;else-exp&gt;</code>分支
<figure class="highlight code-block">
<figcaption>
<span class="language">ruby</span>
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #797593; font-style: italic">@</span><span style="color: #575279; font-style: italic">env</span><span style="color: #575279"> </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #797593">{</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #797593">:&#39;</span><span style="color: #286983">#t</span><span style="color: #797593">&#39;</span><span style="color: #575279"> </span><span style="color: #797593">=&gt;</span><span style="color: #575279"> </span><span style="color: #D7827E">true</span><span style="color: #797593">,</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #797593">:&#39;</span><span style="color: #286983">#f</span><span style="color: #797593">&#39;</span><span style="color: #575279"> </span><span style="color: #797593">=&gt;</span><span style="color: #575279"> </span><span style="color: #D7827E">false</span></span>
<span class="line"><span style="color: #797593">}</span></span>
<span class="line"><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> ...</span></span>
<span class="line"><span style="color: #286983">elsif</span><span style="color: #575279"> exp</span><span style="color: #797593">[</span><span style="color: #D7827E">0</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #286983">==</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">if</span></span>
<span class="line"><span style="color: #575279">    _</span><span style="color: #797593">,</span><span style="color: #575279"> test_exp</span><span style="color: #797593">,</span><span style="color: #575279"> then_exp</span><span style="color: #797593">,</span><span style="color: #575279"> else_exp </span><span style="color: #286983">=</span><span style="color: #575279"> exp</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">if</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">eval</span><span style="color: #797593">(</span><span style="color: #575279">test_exp</span><span style="color: #797593">,</span><span style="color: #575279"> env</span><span style="color: #797593">)</span><span style="color: #575279"> </span><span style="color: #286983">==</span><span style="color: #575279"> </span><span style="color: #D7827E">false</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #B4637A; font-style: italic">eval</span><span style="color: #797593">(</span><span style="color: #575279"> else_exp</span><span style="color: #797593">,</span><span style="color: #575279"> env </span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">else</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> other than false(#f)</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #B4637A; font-style: italic">eval</span><span style="color: #797593">(</span><span style="color: #575279"> then_exp</span><span style="color: #797593">,</span><span style="color: #575279"> env</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">end</span></span></code></pre>
</figure>
<p>ruby注释使用<code>#</code>，如果symbol含有#的话，需要用引号括起来。这里会把Racket的<code>#t #f</code>转化为Ruby中的true和false。</p>
<h3 id="比较操作comparison-operators">比较操作comparison operators</h3>
至于比较操作，上文提过了类似代数操作实现。
当有多个需要比较的对象时，比较操作需要两两比较，所有两两比较结果为true，则返回true，否则false。
<code>each_cons(n)</code>就是(Ruby提供方法来遍历连续<em>consecutive</em>的n个元素)。<a
href="#fn2" class="footnote-ref" id="fnref2"
role="doc-noteref"><sup>2</sup></a>
<figure class="highlight code-block">
<figcaption>
<span class="language">ruby</span> comparision
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #575279; font-style: italic">COMPARISION</span><span style="color: #575279"> </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #797593">[:</span><span style="color: #286983">==</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">!=</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">&lt;</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">&gt;</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">&lt;=</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">&gt;=</span><span style="color: #797593">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">initialize</span><span style="color: #797593">()</span></span>
<span class="line"><span style="color: #797593">    </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> ...</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #56949F">COMPARISION</span><span style="color: #797593">.</span><span style="color: #575279">map </span><span style="color: #286983">do</span><span style="color: #575279"> </span><span style="color: #797593">|</span><span style="color: #575279; font-style: italic">opt</span><span style="color: #797593">|</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #797593; font-style: italic">@</span><span style="color: #575279; font-style: italic">env</span><span style="color: #797593">[</span><span style="color: #575279">opt</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">lambda</span><span style="color: #797593">{</span><span style="color: #575279"> </span><span style="color: #797593">|</span><span style="color: #286983">*</span><span style="color: #575279; font-style: italic">args</span><span style="color: #797593">|</span><span style="color: #575279"> args</span><span style="color: #797593">.</span><span style="color: #575279">each_cons</span><span style="color: #797593">(</span><span style="color: #D7827E">2</span><span style="color: #797593">).</span><span style="color: #575279">all? </span><span style="color: #797593">{|</span><span style="color: #575279; font-style: italic">x</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #575279; font-style: italic">y</span><span style="color: #797593">|</span><span style="color: #575279"> x</span><span style="color: #797593">.</span><span style="color: #575279">method</span><span style="color: #797593">(</span><span style="color: #575279">opt</span><span style="color: #797593">).</span><span style="color: #575279">call</span><span style="color: #797593">(</span><span style="color: #575279">y</span><span style="color: #797593">)}</span><span style="color: #575279"> </span><span style="color: #797593">}</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">end</span></span>
<span class="line"><span style="color: #286983">end</span></span></code></pre>
</figure>
<p>Ruby和其他大部分语言，使用<code>=</code>代表赋值操作，所以比较是否相等时候使用<code>==</code>。但是Racket有专门的<code>define</code>操作，所以依旧使用<code>=</code>代表比较是否相等的函数。<br />
我追求简单，所以实现套用Ruby语法。如果要改为Scheme
Racket语法也很简单，多做一次符号映射即可，其他不做赘述了。</p>
<h3 id="cons-cell-and-list">Cons Cell and List</h3>
<p><code>cons</code>操作用来构建一个pair，其通过<code>car</code>获得pair的第一个数据，通过<code>cdr</code>获得pair的第二个数据，pair有专门的术语：<code>cons cell</code>。</p>
<p>另外Racket有个特许且常用的<code>cons cell</code>形式：<code>list</code>，例如<code>(cons 1 (cons 2 (cons 3 (cons 4 null))))</code>代码，nested
cons
cells，最后一个（最内部的pair）的第二数据以<code>null</code>为结尾。<br />
<code>null</code>在Racket中代表空list，<code>null?</code>判断是否为空的函数。list有个更加简便的写法<code>(list 1 2 3 4)</code>等同上行的代码例子。</p>
<table>
<colgroup>
<col style="width: 17%" />
<col style="width: 40%" />
<col style="width: 42%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Primitive</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">null</td>
<td style="text-align: left;">The empty list</td>
<td style="text-align: left;">null</td>
</tr>
<tr class="even">
<td style="text-align: left;">cons</td>
<td style="text-align: left;">Construct a list</td>
<td style="text-align: left;">(cons 2 (cons 3 null))</td>
</tr>
<tr class="odd">
<td style="text-align: left;">car</td>
<td style="text-align: left;">Get rst element of a list</td>
<td style="text-align: left;">(car some-list)</td>
</tr>
<tr class="even">
<td style="text-align: left;">cdr</td>
<td style="text-align: left;">Get tail of a list</td>
<td style="text-align: left;">(cdr some-list)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">null?</td>
<td style="text-align: left;">Return #t for the empty-list and #f
otherwise</td>
<td style="text-align: left;">(null? some-value)</td>
</tr>
</tbody>
</table>
<p>对于Ruby实现代码，我们使用array来存放<code>cons cells</code>，固定两个元素。</p>
<p>对于<code>list</code>函数实现，依旧采用recursion方式，cons（直接构造Ruby
array）第一个参数以及余下参数构成的list，很直白实现方式。</p>
<figure class="highlight code-block">
<figcaption>
<span class="language">ruby</span> cons cells
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #797593">:</span><span style="color: #286983">null?</span><span style="color: #575279"> </span><span style="color: #797593">=&gt;</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">lambda</span><span style="color: #575279"> </span><span style="color: #797593">{</span><span style="color: #575279"> </span><span style="color: #797593">|</span><span style="color: #575279; font-style: italic">exp</span><span style="color: #797593">|</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">null</span><span style="color: #575279"> </span><span style="color: #286983">==</span><span style="color: #575279"> exp </span><span style="color: #797593">},</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> racket empty list.</span></span>
<span class="line"><span style="color: #797593">:</span><span style="color: #286983">cons</span><span style="color: #575279"> </span><span style="color: #797593">=&gt;</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">lambda</span><span style="color: #575279"> </span><span style="color: #797593">{</span><span style="color: #575279"> </span><span style="color: #797593">|</span><span style="color: #575279; font-style: italic">x</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #575279; font-style: italic">cell</span><span style="color: #797593">|</span><span style="color: #575279"> </span><span style="color: #797593">[</span><span style="color: #575279">x</span><span style="color: #797593">,</span><span style="color: #575279"> cell</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #797593">},</span></span>
<span class="line"><span style="color: #797593">:</span><span style="color: #286983">car</span><span style="color: #575279"> </span><span style="color: #797593">=&gt;</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">lambda</span><span style="color: #575279"> </span><span style="color: #797593">{</span><span style="color: #575279"> </span><span style="color: #797593">|</span><span style="color: #575279; font-style: italic">cell</span><span style="color: #797593">|</span><span style="color: #575279"> cell</span><span style="color: #797593">[</span><span style="color: #D7827E">0</span><span style="color: #797593">]},</span></span>
<span class="line"><span style="color: #797593">:</span><span style="color: #286983">cdr</span><span style="color: #575279"> </span><span style="color: #797593">=&gt;</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">lambda</span><span style="color: #575279"> </span><span style="color: #797593">{</span><span style="color: #575279"> </span><span style="color: #797593">|</span><span style="color: #575279; font-style: italic">cell</span><span style="color: #797593">|</span><span style="color: #575279"> cell</span><span style="color: #797593">[</span><span style="color: #D7827E">1</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #797593">},</span></span>
<span class="line"><span style="color: #797593">:</span><span style="color: #286983">list</span><span style="color: #575279"> </span><span style="color: #797593">=&gt;</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">lambda</span><span style="color: #575279"> </span><span style="color: #286983">do</span><span style="color: #575279"> </span><span style="color: #797593">|</span><span style="color: #286983">*</span><span style="color: #575279; font-style: italic">args</span><span style="color: #797593">|</span></span>
<span class="line"><span style="color: #797593">    </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> racket code &#39;(list 1 2 3)&#39; is equivalent to &#39;(cons 1 (cons 2 (cons 3 null)))&#39;</span></span>
<span class="line"><span style="color: #575279">    racket_list_helper</span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">lambda</span><span style="color: #575279"> </span><span style="color: #286983">do</span><span style="color: #575279"> </span><span style="color: #797593">|</span><span style="color: #575279; font-style: italic">args</span><span style="color: #797593">|</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">if</span><span style="color: #575279"> args</span><span style="color: #797593">.</span><span style="color: #575279">empty? </span><span style="color: #286983">then</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">null</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">else</span><span style="color: #575279"> </span><span style="color: #797593">[</span><span style="color: #575279">args</span><span style="color: #797593">[</span><span style="color: #D7827E">0</span><span style="color: #797593">],</span><span style="color: #575279"> racket_list_helper</span><span style="color: #797593">.</span><span style="color: #575279">call</span><span style="color: #797593">(</span><span style="color: #575279">args</span><span style="color: #797593">[</span><span style="color: #D7827E">1</span><span style="color: #797593">..</span><span style="color: #286983">-</span><span style="color: #D7827E">1</span><span style="color: #797593">])]</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">end</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">end</span></span>
<span class="line"><span style="color: #575279">    racket_list_helper</span><span style="color: #797593">.</span><span style="color: #575279">call</span><span style="color: #797593">(</span><span style="color: #575279">args</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #286983">end</span></span></code></pre>
</figure>
<!-- TODO: map, filter, fold -->
<h3 id="functionslambda-and-apply">Functions，Lambda and Apply</h3>
<!-- pullquote "has-quotes"  endpullquote  TODO: pullquote style  -->
<blockquote>
<p>问题弄清楚后，答案自然就清楚了。</p>
</blockquote>
<p>到了我觉得最重要的function部分了。目标实现function，只需要搞清楚何为function就知道如何实现，首先先要明确一些相关的概念。</p>
<p>Racket的函数遵循<code>lexical scope</code>又称作<code>static scope</code>，函数的正文部分求值时，所用的environment在该函数被定义时候的enviroment。相对立的<code>dynamic scope</code>，就是函数求值时，使用的函数被调用的enviroment。</p>
<blockquote>
<p>The body of function is evaluated in the environment when the
function is <strong>defined</strong>, not the environment when the
function is <strong>called</strong>.</p>
</blockquote>
<p>现在主流编程语言基本都是使用<code>lexical scope</code>，程序行为更可控。</p>
<p>除了定义的时候的environment，方法执行的时候，还会将该environment扩展添加参数<em>parameters</em>以及其对应传入的值<em>arguments</em>。</p>
<p>function(或者叫lambda,
procedure)的实现代码如下，存放lambda的parameters和body，以及定义时候的envrioment，就如同上文描述那样。</p>
<p>定义了Closure
class，只是用来存放closure的值。也可以用数组<code>[:closure, parameters, body, env]</code>存放，通过index取值，但是这样的话<code>:closure</code>可以被覆盖。</p>
<p>真正执行部分，处于之前执行方法部分，之前处理例如加法之类的primitive
procedures。现在增加分支专门处理，用户定义的函数<em>compound
procedures</em>。
操作数部分与之前一样，先eval，然后补充进函数定义时的environment。该environment为执行函数体<em>body</em>的环境，然后求值。</p>
<figure class="highlight code-block">
<figcaption>
<span class="language">ruby</span> closure
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #286983">class</span><span style="color: #575279"> </span><span style="color: #56949F">Closure</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">attr_reader</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">parameters</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">body</span><span style="color: #797593">,</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">env</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">initialize</span><span style="color: #797593">(</span><span style="color: #907AA9; font-style: italic">parameters</span><span style="color: #575279">, </span><span style="color: #907AA9; font-style: italic">body</span><span style="color: #575279"> ,</span><span style="color: #907AA9; font-style: italic">env</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #797593; font-style: italic">@</span><span style="color: #575279; font-style: italic">parameters</span><span style="color: #575279"> </span><span style="color: #286983">=</span><span style="color: #575279"> parameters</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #797593; font-style: italic">@</span><span style="color: #575279; font-style: italic">body</span><span style="color: #575279"> </span><span style="color: #286983">=</span><span style="color: #575279"> body</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #797593; font-style: italic">@</span><span style="color: #575279; font-style: italic">env</span><span style="color: #575279"> </span><span style="color: #286983">=</span><span style="color: #575279"> env</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">end</span></span>
<span class="line"><span style="color: #286983">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">eval</span><span style="color: #797593">(</span><span style="color: #907AA9; font-style: italic">exp</span><span style="color: #575279">, </span><span style="color: #907AA9; font-style: italic">env</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #797593">    </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> ... other part code</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">elsif</span><span style="color: #575279"> exp</span><span style="color: #797593">[</span><span style="color: #D7827E">0</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #286983">==</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">lambda</span></span>
<span class="line"><span style="color: #575279">        _</span><span style="color: #797593">,</span><span style="color: #575279"> parameter_names</span><span style="color: #797593">,</span><span style="color: #575279"> fun_body </span><span style="color: #286983">=</span><span style="color: #575279"> exp</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #56949F">Closure</span><span style="color: #797593">.</span><span style="color: #286983">new</span><span style="color: #797593">(</span><span style="color: #575279">parameter_names</span><span style="color: #797593">,</span><span style="color: #575279"> fun_body</span><span style="color: #797593">,</span><span style="color: #575279"> env</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #797593">    </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> ... other part code</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">else</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> call function</span></span>
<span class="line"><span style="color: #575279">        operator </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">eval</span><span style="color: #797593">(</span><span style="color: #575279">exp</span><span style="color: #797593">[</span><span style="color: #D7827E">0</span><span style="color: #797593">],</span><span style="color: #575279"> env</span><span style="color: #797593">)</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> first thing of s-expression sequence.</span></span>
<span class="line"><span style="color: #575279">        operands </span><span style="color: #286983">=</span><span style="color: #575279"> exp</span><span style="color: #797593">[</span><span style="color: #D7827E">1</span><span style="color: #797593">..</span><span style="color: #286983">-</span><span style="color: #D7827E">1</span><span style="color: #797593">].</span><span style="color: #575279">map </span><span style="color: #797593">{|</span><span style="color: #575279; font-style: italic">sub_exp</span><span style="color: #797593">|</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">eval</span><span style="color: #797593">(</span><span style="color: #575279">sub_exp</span><span style="color: #797593">,</span><span style="color: #575279"> env</span><span style="color: #797593">)</span><span style="color: #575279"> </span><span style="color: #797593">}</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> the rest things of sequence</span></span>
<span class="line"></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">if</span><span style="color: #575279"> operator</span><span style="color: #797593">.</span><span style="color: #575279">is_a? </span><span style="color: #575279; font-style: italic">Closure</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> compounded procedures(user-defined)# extends environment with parameters and their actual arguments applied.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #575279">            env_fn </span><span style="color: #286983">=</span><span style="color: #575279"> operator</span><span style="color: #797593">.</span><span style="color: #575279">parameters</span><span style="color: #797593">.</span><span style="color: #575279">zip</span><span style="color: #797593">(</span><span style="color: #575279">operands</span><span style="color: #797593">)</span><span style="color: #575279"> </span><span style="color: #286983">+</span><span style="color: #575279"> operator</span><span style="color: #797593">.</span><span style="color: #575279">env</span></span>
<span class="line"><span style="color: #575279">            body </span><span style="color: #286983">=</span><span style="color: #575279"> operator</span><span style="color: #797593">.</span><span style="color: #575279">body</span></span>
<span class="line"><span style="color: #575279">            </span><span style="color: #B4637A; font-style: italic">eval</span><span style="color: #797593">(</span><span style="color: #575279">body</span><span style="color: #797593">,</span><span style="color: #575279"> env_fn</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">else</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> primitive operators</span></span>
<span class="line"><span style="color: #575279">            operator</span><span style="color: #797593">.</span><span style="color: #575279">call </span><span style="color: #286983">*</span><span style="color: #575279">operands</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">end</span></span></code></pre>
</figure>
<p>另外environment有了较大的改动，之前使用hash结构，在写这篇文章的时候，我重新审查代码时候，发现有较大缺陷：</p>
<ul>
<li>之前hash结构，define定义新变量是直接更改该hash本身，mutation操作。定义lambda的时候，最初直接传入env本身，然而因为hash是可变的，所以实现的是<code>dynamic scope</code>方式，后续对env操作也会影响函数定义是当前的env(就是同一个对象)。</li>
<li>我最初的处理方法是，对于函数定义时候的env，使用一个新的对象<code>env.clone</code>。似乎解决了问题，但是在某些simultaneous同时发生，比如需要两个方法同时定义，如果通过<code>env.clone</code>，两个方法的env是两个独立对象，然而我们需要两个方法env都是同一个对象，因为它们处于并列状态，例如<code>letrec</code>（不是本文重点，但代码中有实现）。</li>
</ul>
<p>所以，需要改变的是：</p>
<ul>
<li>define添加新的variable到当前env（并不改变原先env）作为新的env。相当于新的environment是immutable。</li>
<li>定义lambda的时候，直接使用当前的env。</li>
</ul>
<figure>
<img src="/assets/images/2017-RacketOnRuby/closure-env.jpg"
alt="the environment of the closure" />
<figcaption aria-hidden="true">the environment of the
closure</figcaption>
</figure>
<p>对应到ruby代码实现。使用array取代hash，其中每个元素即变量和其对应的值（2个元素的array分别存variable,value）。
define时候通过 <code>env[0..-1]</code>
重新赋值env。由于现在需要直接更改当前的environment，而且ruby不支持参数传入引用，所以我使用<code>env[0..-1] = [new array]</code>将env内的array中的元素替换成新的env（包含新定义的variable），来达到更改当前environment目的。</p>
<figure class="highlight code-block">
<figcaption>
<span class="language">ruby</span> new environment
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #797593; font-style: italic">@</span><span style="color: #575279; font-style: italic">env</span><span style="color: #575279"> </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #797593">[</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #797593">[:&#39;</span><span style="color: #286983">#t</span><span style="color: #797593">&#39;</span><span style="color: #575279"> </span><span style="color: #797593">,</span><span style="color: #575279">  </span><span style="color: #D7827E">true</span><span style="color: #797593">],</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #797593">[:&#39;</span><span style="color: #286983">#f</span><span style="color: #797593">&#39;</span><span style="color: #575279"> </span><span style="color: #797593">,</span><span style="color: #575279">  </span><span style="color: #D7827E">false</span><span style="color: #797593">],</span></span>
<span class="line"><span style="color: #797593">    </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> Racket &#39;not&#39; operator if exp is #f, results #t. otherwise false. it differents from ruby not</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #797593">[:</span><span style="color: #286983">not</span><span style="color: #575279"> </span><span style="color: #797593">,</span><span style="color: #575279">  </span><span style="color: #B4637A; font-style: italic">lambda</span><span style="color: #575279"> </span><span style="color: #797593">{</span><span style="color: #575279"> </span><span style="color: #797593">|</span><span style="color: #575279; font-style: italic">exp</span><span style="color: #797593">|</span><span style="color: #575279"> </span><span style="color: #286983">if</span><span style="color: #575279"> </span><span style="color: #D7827E">false</span><span style="color: #286983">==</span><span style="color: #575279">exp </span><span style="color: #286983">then</span><span style="color: #575279"> </span><span style="color: #D7827E">true</span><span style="color: #575279"> </span><span style="color: #286983">else</span><span style="color: #575279"> </span><span style="color: #D7827E">false</span><span style="color: #575279"> </span><span style="color: #286983">end</span><span style="color: #575279"> </span><span style="color: #797593">}],</span></span>
<span class="line"><span style="color: #797593">    </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> ... other primitive procedures.</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #797593">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">eval</span><span style="color: #797593">(</span><span style="color: #907AA9; font-style: italic">exp</span><span style="color: #575279">, </span><span style="color: #907AA9; font-style: italic">env</span><span style="color: #286983">=</span><span style="color: #797593; font-style: italic">@</span><span style="color: #575279; font-style: italic">env</span><span style="color: #797593">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">def</span><span style="color: #575279"> </span><span style="color: #D7827E">lookup_env</span><span style="color: #797593">(</span><span style="color: #907AA9; font-style: italic">env</span><span style="color: #575279">, </span><span style="color: #907AA9; font-style: italic">var</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">        error_no_var </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #EA9D34">&quot;undefined: %s !&quot;</span><span style="color: #575279"> </span><span style="color: #286983">%</span><span style="color: #575279"> var</span></span>
<span class="line"><span style="color: #575279">        var_val </span><span style="color: #286983">=</span><span style="color: #575279"> env</span><span style="color: #797593">.</span><span style="color: #575279">assoc var</span></span>
<span class="line"></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">if</span><span style="color: #575279"> var_val</span><span style="color: #797593">.</span><span style="color: #575279">nil?</span></span>
<span class="line"><span style="color: #575279">            </span><span style="color: #286983">raise</span><span style="color: #575279"> error_no_var</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">elsif</span><span style="color: #575279"> var_val</span><span style="color: #797593">[</span><span style="color: #D7827E">1</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #286983">==</span><span style="color: #575279"> </span><span style="color: #575279; font-style: italic">UNASSIGNED_VAL</span></span>
<span class="line"><span style="color: #575279">            </span><span style="color: #286983">raise</span><span style="color: #575279"> </span><span style="color: #EA9D34">&quot;the unassigned value should not be access.&quot;</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">else</span></span>
<span class="line"><span style="color: #575279">            </span><span style="color: #286983">return</span><span style="color: #575279"> var_val</span><span style="color: #797593">[</span><span style="color: #D7827E">1</span><span style="color: #797593">]</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #286983">end</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #797593">    </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> ... other eval parts</span></span>
<span class="line"><span style="color: #575279">    </span><span style="color: #286983">elsif</span><span style="color: #575279"> exp</span><span style="color: #797593">[</span><span style="color: #D7827E">0</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #286983">==</span><span style="color: #575279"> </span><span style="color: #797593">:</span><span style="color: #286983">define</span></span>
<span class="line"><span style="color: #575279">        _</span><span style="color: #797593">,</span><span style="color: #575279"> var</span><span style="color: #797593">,</span><span style="color: #575279"> value_exp </span><span style="color: #286983">=</span><span style="color: #575279"> exp</span></span>
<span class="line"></span>
<span class="line"><span style="color: #575279">        value </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #B4637A; font-style: italic">eval</span><span style="color: #797593">(</span><span style="color: #575279"> value_exp</span><span style="color: #797593">,</span><span style="color: #575279"> env </span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">        env</span><span style="color: #797593">[</span><span style="color: #D7827E">0</span><span style="color: #797593">..</span><span style="color: #286983">-</span><span style="color: #D7827E">1</span><span style="color: #797593">]</span><span style="color: #575279"> </span><span style="color: #286983">=</span><span style="color: #575279"> </span><span style="color: #797593">[[</span><span style="color: #575279">var </span><span style="color: #797593">,</span><span style="color: #575279"> value</span><span style="color: #797593">]]</span><span style="color: #575279"> </span><span style="color: #286983">+</span><span style="color: #575279"> env</span></span>
<span class="line"><span style="color: #797593">    </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> ... other eval parts</span></span>
<span class="line"><span style="color: #286983">end</span><span style="color: #575279"> </span><span style="color: #797593; font-style: italic">#</span><span style="color: #9893A5; font-style: italic"> eval</span></span></code></pre>
</figure>
<p>至此，最重要的lambda部分就已经完成实现了。</p>
<h2 id="racketonruby总结">RacketOnRuby总结</h2>
<p>出于练习目的，实现Racket的一个解析器。从功能完整性和性能考虑，并不适合实际生产中运用。</p>
<p>得益于Racket语法统一简单，实现也相对简单。不像很多别的语言，有大量不同形式的语法。</p>
<ul>
<li>相对于原生Racket，肯定缺少一些功能，但常见的基本都实现了。
<ul>
<li>实现了environment、variable、condition(if)、 lambda、 cons cells、
list、 一些primitive procedures(代数运算，数值比较)。</li>
<li>语法缺少的：注释<em>comment</em>、 quote、 # symbol(字面量类似Ruby
symbol)、 一些derived
expression(可以转化为现有的别的表达式，例如cond用来多个条件判断，可以转化为嵌套的if)</li>
<li>项目中代码是实现有<code>let</code>和<code>letrec</code>，也是derived
expression。<code>(let ([&lt;var&gt; &lt;exp&gt;]) body)</code>其作用就是绑定local
variable，并在其environment执行body部分代码。<code>let</code>可以转为<code>lambda</code>,
<code>letrec</code>可以转为一种特殊形式<code>let</code>。转化方法是直接操作AST，由于Ruby中AST用的Array表现，并不是那么清晰，所以不做本文重点。（相对于metalanguage使用Lisp系语言，Lisp系语言code即data，代码部分也可以操作，即可以直接在程序expression上直接操作）</li>
<li>缺少大量primitive
procedures，语言肯定会有大量自带的函数，不可能一一实现。其中之一就是mutation
list，Racket的默认list是不可变的immutable。如果需要可变的，有专门的操作:<code>mcons</code>，<code>set-mcar!</code>,
<code>set-mcdr!</code>。这一点也是Racket与Scheme不同的一处，Scheme中list是mutation
list。</li>
<li>error
handling不是主要目标，所以几乎没有异常错误处理，所以需要执行的program先要保证正确的。可以DrRacket先执行一遍，尤其括号方面（多或者少，不匹配），IDE可以很明显看出括号范围。</li>
</ul></li>
<li>性能方面，也不是主要目标，没有特别优化。下面指出一些可以改进的地方：
<ul>
<li><code>eval</code>实现，实际上语义分析<em>syntactic
analysis</em>夹杂在执行<em>execution</em>之中，不是有效率的做法。如下阶乘的program，当执行<code>(factorial 5)</code>，递归调用<code>factorial</code>多次，其中<code>if</code>部分每次都需要判断出是<code>if</code>，但执行到<code>(* (factorial (- n 1)) n)))</code>其中<code>(- n 1)</code>和<code>(factorial (- n 1))</code>都需要在<code>eval</code>判断出是方法执行然后再处理。非常重复浪费的做法，需要将analysis分离出来，本文并没涉及，具体实现可以参考SICP<a
href="#fn3" class="footnote-ref" id="fnref3"
role="doc-noteref"><sup>3</sup></a>第四大章中<em>Separating Syntactic
Analysis from Execution</em>小节部分
<figure class="highlight code-block">
<figcaption>
<span class="language">scheme</span>
</figcaption>
<pre class="shiki rose-pine-dawn" style="background-color: #faf4ed" tabindex="0"><code><span class="line"><span style="color: #575279">    </span><span style="color: #797593">(</span><span style="color: #286983">define</span><span style="color: #575279"> </span><span style="color: #797593">(</span><span style="color: #D7827E">factorial</span><span style="color: #907AA9; font-style: italic"> n</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">        </span><span style="color: #797593">(</span><span style="color: #286983">if</span><span style="color: #575279"> </span><span style="color: #797593">(</span><span style="color: #286983">=</span><span style="color: #575279"> n </span><span style="color: #D7827E">1</span><span style="color: #797593">)</span></span>
<span class="line"><span style="color: #575279">            </span><span style="color: #D7827E">1</span></span>
<span class="line"><span style="color: #575279">            </span><span style="color: #797593">(</span><span style="color: #286983">*</span><span style="color: #575279"> </span><span style="color: #797593">(</span><span style="color: #575279">factorial </span><span style="color: #797593">(</span><span style="color: #286983">-</span><span style="color: #575279"> n </span><span style="color: #D7827E">1</span><span style="color: #797593">))</span><span style="color: #575279"> n</span><span style="color: #797593">)))</span></span></code></pre>
</figure></li>
<li>缺少<code>TCO</code><em>tail call
optimization</em>，尾递归优化，Lisp和Scheme系的语言program非常依赖与递归调用，TCO非常重要，能省去很多function
call占用的stack空间。</li>
</ul></li>
</ul>
<p>要想了解interpreter如何工作，最好办法就是自己实现一个了，这就是我实现RacketOnRuby以及写本文的目的。
如果需要更深入了解，推荐上文提及SICP以及另外一本书TSPL<a href="#fn4"
class="footnote-ref" id="fnref4"
role="doc-noteref"><sup>4</sup></a>，都是有免费阅读的电子版。或者自行搜索，有相当多的资料。</p>
<p>另外文章最开始提及的《黑客与画家》，非编程技术书，也推荐阅读。语言通俗易懂，不涉及技术细节，阅读不费力，非程序员也能读。但其中作者的思想条理清晰，观点深入透彻。另外本书也不光全是关于Lisp，还有一些有趣事情，我印象较深的就是最开始的章节”为什么书呆子不受欢迎”。</p>
<p>{# &gt; The prefixes <code>#b</code>, <code>#o</code>, and
<code>#x</code> specify binary, octal, and hexadecimal interpretation of
digits</p>
<h4
id="implemention-on-racket-environment-using-cons-benifit-sharing-small-part-due-to-immutation">implemention
on Racket environment using cons (benifit sharing small part due to
immutation)</h4>
<p>#}</p>
<!-- toc -->
<section id="footnotes" class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p><a
href="https://ruby-doc.org/core-2.4.0/String.html#method-i-split">Ruby
Doc: String.split</a>: If pattern is a String, then its contents are
used as the delimiter when splitting str. If pattern is <strong>a single
space</strong>, str is split on <strong>whitespace</strong>, with
leading whitespace and runs of <strong>contiguous whitespace characters
ignored</strong>.<a href="#fnref1" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><a
href="https://ruby-doc.org/core-2.4.0/Enumerable.html#method-i-each_cons">Ruby
Doc Enumerable each_cons(n)</a>: Iterates the given block for each array
of consecutive <n> elements. If no block is given, returns an
enumerator.<a href="#fnref2" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p><em>Structure and Interpretation of Computer
Programs</em> <a
href="https://mitpress.mit.edu/sicp/full-text/book/book.html">MIT
scheme课程书籍</a>. <a href="#fnref3" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p><em>The Scheme Programming Language</em> <a
href="http://www.scheme.com/tspl4/">http://www.scheme.com/tspl4/</a>. <a
href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

  </section>

  <footer class="post-footer">
    <ul class="post-tags">
      
        <li>#programming</li>
      
        <li>#interpreter</li>
      
        <li>#racket</li>
      
        <li>#ruby</li>
      
        <li>#lambda</li>
      
        <li>#scheme</li>
      
        <li>#lisp</li>
      
        <li>#eval</li>
      
    </ul>
  </footer>
</article>


  </body>
</html>
